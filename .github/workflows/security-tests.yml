name: Security Tests

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HRMS Security Testing Pipeline
# Automated penetration testing with OWASP ZAP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: true
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full
      target_url:
        description: 'API URL to scan'
        required: true
        default: 'https://api.yourdomain.com'

  # Weekly scheduled security scans
  schedule:
    - cron: '0 3 * * 0'  # Run at 3 AM UTC every Sunday

  # Before production deployments
  workflow_run:
    workflows: ["Deploy to Production"]
    types:
      - completed

env:
  TARGET_URL: ${{ inputs.target_url || 'https://api.yourdomain.com' }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # OWASP ZAP BASELINE SCAN
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  baseline-scan:
    name: OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'baseline' || github.event.schedule }}
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p tests/security/results

      - name: Run ZAP Baseline Scan
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tests/security/results:/zap/wrk/:rw \
            -t owasp/zap2docker-stable \
            zap-baseline.py \
            -t ${{ env.TARGET_URL }} \
            -r zap-baseline-report.html \
            -J zap-baseline-report.json \
            -I || true

      - name: Upload Baseline Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-results
          path: tests/security/results/
          retention-days: 90

      - name: Analyze Results
        if: always()
        run: |
          if [ -f tests/security/results/zap-baseline-report.json ]; then
            echo "## ğŸ”’ Security Scan Results (Baseline)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Count alerts by risk level
            HIGH=$(cat tests/security/results/zap-baseline-report.json | jq '[.site[].alerts[] | select(.riskdesc | startswith("High"))] | length' || echo "0")
            MEDIUM=$(cat tests/security/results/zap-baseline-report.json | jq '[.site[].alerts[] | select(.riskdesc | startswith("Medium"))] | length' || echo "0")
            LOW=$(cat tests/security/results/zap-baseline-report.json | jq '[.site[].alerts[] | select(.riskdesc | startswith("Low"))] | length' || echo "0")

            echo "- ğŸ”´ **HIGH Risk:** $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŸ¡ **MEDIUM Risk:** $MEDIUM" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŸ¢ **LOW Risk:** $LOW" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Fail if HIGH risk found
            if [ "$HIGH" -gt 0 ]; then
              echo "âŒ **CRITICAL:** $HIGH HIGH risk vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # OWASP ZAP FULL SCAN
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  full-scan:
    name: OWASP ZAP Full Scan
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'full' }}
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p tests/security/results

      - name: Run ZAP Full Scan
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tests/security/results:/zap/wrk/:rw \
            -t owasp/zap2docker-stable \
            zap-full-scan.py \
            -t ${{ env.TARGET_URL }} \
            -r zap-full-scan-report.html \
            -J zap-full-scan-report.json \
            -x zap-full-scan-report.xml \
            -I || true

      - name: Upload Full Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-scan-results
          path: tests/security/results/
          retention-days: 90

      - name: Analyze Results
        if: always()
        run: |
          if [ -f tests/security/results/zap-full-scan-report.json ]; then
            echo "## ğŸ”’ Security Scan Results (Full)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Count alerts by risk level
            HIGH=$(cat tests/security/results/zap-full-scan-report.json | jq '[.site[].alerts[] | select(.riskdesc | startswith("High"))] | length' || echo "0")
            MEDIUM=$(cat tests/security/results/zap-full-scan-report.json | jq '[.site[].alerts[] | select(.riskdesc | startswith("Medium"))] | length' || echo "0")
            LOW=$(cat tests/security/results/zap-full-scan-report.json | jq '[.site[].alerts[] | select(.riskdesc | startswith("Low"))] | length' || echo "0")
            INFO=$(cat tests/security/results/zap-full-scan-report.json | jq '[.site[].alerts[] | select(.riskdesc | startswith("Informational"))] | length' || echo "0")

            echo "- ğŸ”´ **HIGH Risk:** $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŸ¡ **MEDIUM Risk:** $MEDIUM" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŸ¢ **LOW Risk:** $LOW" >> $GITHUB_STEP_SUMMARY
            echo "- â„¹ï¸ **Informational:** $INFO" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show top HIGH risk issues
            if [ "$HIGH" -gt 0 ]; then
              echo "### Top HIGH Risk Issues:" >> $GITHUB_STEP_SUMMARY
              cat tests/security/results/zap-full-scan-report.json | jq -r '.site[].alerts[] | select(.riskdesc | startswith("High")) | "- **\(.alert)**: \(.desc | .[0:100])..."' | head -5 >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âŒ **CRITICAL:** $HIGH HIGH risk vulnerabilities must be fixed!" >> $GITHUB_STEP_SUMMARY
              exit 1
            elif [ "$MEDIUM" -gt 5 ]; then
              echo "âš ï¸ **WARNING:** $MEDIUM MEDIUM risk vulnerabilities found. Review required." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **PASSED:** No critical security issues found!" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECURITY HEADERS CHECK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  security-headers:
    name: Security Headers Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check Security Headers
        run: |
          echo "## ğŸ” Security Headers Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for required security headers
          RESPONSE=$(curl -I -s ${{ env.TARGET_URL }}/health)

          # X-Frame-Options
          if echo "$RESPONSE" | grep -i "X-Frame-Options"; then
            echo "- âœ… X-Frame-Options: Present" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ X-Frame-Options: Missing" >> $GITHUB_STEP_SUMMARY
          fi

          # X-Content-Type-Options
          if echo "$RESPONSE" | grep -i "X-Content-Type-Options"; then
            echo "- âœ… X-Content-Type-Options: Present" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ X-Content-Type-Options: Missing" >> $GITHUB_STEP_SUMMARY
          fi

          # Strict-Transport-Security
          if echo "$RESPONSE" | grep -i "Strict-Transport-Security"; then
            echo "- âœ… Strict-Transport-Security: Present" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Strict-Transport-Security: Missing" >> $GITHUB_STEP_SUMMARY
          fi

          # Content-Security-Policy
          if echo "$RESPONSE" | grep -i "Content-Security-Policy"; then
            echo "- âœ… Content-Security-Policy: Present" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Content-Security-Policy: Missing (recommended)" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOYMENT GATE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [baseline-scan, security-headers]
    if: always()

    steps:
      - name: Check Security Status
        run: |
          if [ "${{ needs.baseline-scan.result }}" == "failure" ]; then
            echo "âŒ Security scan failed - deployment blocked"
            exit 1
          else
            echo "âœ… Security checks passed - safe to deploy"
          fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NOTES:
# - Baseline scans run automatically weekly and before deployments
# - Full scans must be triggered manually due to long runtime
# - HIGH risk findings block deployments
# - Results are retained for 90 days for compliance
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
