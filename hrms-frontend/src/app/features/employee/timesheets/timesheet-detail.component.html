<div class="timesheet-detail-container">
  @if (loading()) {
    <div class="loading-container">
      <app-progress-spinner size="medium" color="primary"></app-progress-spinner>
      <p>Loading timesheet details...</p>
    </div>
  } @else if (timesheet()) {
    <!-- Header -->
    <div class="detail-header">
      <button mat-icon-button (click)="goBack()" class="back-button">
        <app-icon name="arrow_back"></app-icon>
      </button>
      <div class="header-content">
        <h1>Timesheet Details</h1>
        <p class="subtitle">{{ getPeriodDisplay() }}</p>
      </div>
      <app-chip
        [label]="getStatusLabel(timesheet()!.status)"
        [color]="getStatusColor(timesheet()!.status)">
      </app-chip>
    </div>

    <!-- Summary Cards -->
    <div class="summary-grid">
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-icon regular">
            <app-icon name="access_time"></app-icon>
          </div>
          <div class="summary-details">
            <div class="summary-value">{{ formatHours(getTotalRegularHours()) }}</div>
            <div class="summary-label">Regular Hours</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-icon overtime">
            <app-icon name="schedule"></app-icon>
          </div>
          <div class="summary-details">
            <div class="summary-value">{{ formatHours(getTotalOvertimeHours()) }}</div>
            <div class="summary-label">Overtime Hours</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-icon holiday">
            <app-icon name="beach_access"></app-icon>
          </div>
          <div class="summary-details">
            <div class="summary-value">{{ formatHours(getTotalHolidayHours()) }}</div>
            <div class="summary-label">Holiday Hours</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-icon leave">
            <app-icon name="event_busy"></app-icon>
          </div>
          <div class="summary-details">
            <div class="summary-value">{{ formatHours(getTotalLeaveHours()) }}</div>
            <div class="summary-label">Leave Hours</div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Payable Hours Banner -->
    <mat-card class="payable-banner">
      <mat-card-content>
        <div class="payable-content">
          <div class="payable-icon">
            <app-icon name="payments"></app-icon>
          </div>
          <div class="payable-details">
            <div class="payable-label">Total Payable Hours</div>
            <div class="payable-value">{{ formatHours(getTotalPayableHours()) }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Daily Entries Table -->
    <mat-card class="entries-card">
      <mat-card-header>
        <mat-card-title>
          <app-icon name="calendar_today"></app-icon>
          Daily Breakdown
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <app-table
            [columns]="columns"
            [data]="timesheet()?.entries || []"
            [loading]="loading()"
            [hoverable]="true"
            class="entries-table">

            <!-- Date Column -->
            <ng-template appTableColumn="date" let-entry>
              <div class="date-cell">
                <strong>{{ formatDate(entry.date) }}</strong>
              </div>
            </ng-template>

            <!-- Day Type Column -->
            <ng-template appTableColumn="dayType" let-entry>
              <span [class]="'day-type-badge ' + getDayTypeColor(entry.dayType)">
                {{ getDayTypeLabel(entry.dayType) }}
              </span>
            </ng-template>

            <!-- Clock In Column -->
            <ng-template appTableColumn="clockIn" let-entry>
              {{ formatTime(entry.clockInTime) }}
            </ng-template>

            <!-- Clock Out Column -->
            <ng-template appTableColumn="clockOut" let-entry>
              {{ formatTime(entry.clockOutTime) }}
            </ng-template>

            <!-- Regular Hours Column -->
            <ng-template appTableColumn="regular" let-entry>
              @if (entry.regularHours > 0) {
                <span class="hours-value">{{ formatHours(entry.regularHours) }}</span>
              } @else {
                <span class="no-hours">-</span>
              }
            </ng-template>

            <!-- Overtime Column -->
            <ng-template appTableColumn="overtime" let-entry>
              @if (entry.overtimeHours > 0) {
                <span class="hours-value overtime">{{ formatHours(entry.overtimeHours) }}</span>
              } @else {
                <span class="no-hours">-</span>
              }
            </ng-template>

            <!-- Total Column -->
            <ng-template appTableColumn="total" let-entry>
              @if (getTotalHours(entry) > 0) {
                <strong>{{ formatHours(getTotalHours(entry)) }}</strong>
              } @else {
                <span class="no-hours">-</span>
              }
            </ng-template>

            <!-- Notes Column -->
            <ng-template appTableColumn="notes" let-entry>
              @if (entry.notes) {
                <span class="notes-text" [appTooltip]="entry.notes">
                  {{ entry.notes.substring(0, 30) }}{{ entry.notes.length > 30 ? '...' : '' }}
                </span>
              } @else {
                <span class="no-hours">-</span>
              }
            </ng-template>
          </app-table>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Metadata Card -->
    <mat-card class="metadata-card">
      <mat-card-header>
        <mat-card-title>
          <app-icon name="info"></app-icon>
          Timesheet Information
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metadata-grid">
          <div class="metadata-item">
            <span class="metadata-label">Created:</span>
            <span class="metadata-value">{{ formatDate(timesheet()!.createdAt) }}</span>
          </div>

          @if (timesheet()!.submittedAt) {
            <div class="metadata-item">
              <span class="metadata-label">Submitted:</span>
              <span class="metadata-value">{{ formatDate(timesheet()!.submittedAt!) }}</span>
            </div>
          }

          @if (timesheet()!.approvedAt) {
            <div class="metadata-item">
              <span class="metadata-label">Approved:</span>
              <span class="metadata-value">{{ formatDate(timesheet()!.approvedAt!) }} by {{ timesheet()!.approvedByName }}</span>
            </div>
          }

          @if (timesheet()!.rejectedAt) {
            <div class="metadata-item">
              <span class="metadata-label">Rejected:</span>
              <span class="metadata-value">{{ formatDate(timesheet()!.rejectedAt!) }}</span>
            </div>
          }

          @if (timesheet()!.rejectionReason) {
            <div class="metadata-item full-width">
              <span class="metadata-label">Rejection Reason:</span>
              <span class="metadata-value rejection">{{ timesheet()!.rejectionReason }}</span>
            </div>
          }

          @if (timesheet()!.isLocked) {
            <div class="metadata-item">
              <span class="metadata-label">Status:</span>
              <span class="metadata-value locked">
                <app-icon name="lock"></app-icon>
                Locked
              </span>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Action Buttons -->
    <div class="action-container">
      <button mat-raised-button (click)="goBack()">
        <app-icon name="arrow_back"></app-icon>
        Back to List
      </button>

      @if (canSubmit()) {
        <button mat-raised-button color="primary" (click)="submitTimesheet()">
          <app-icon name="send"></app-icon>
          Submit for Approval
        </button>
      }
    </div>
  }
</div>
