<div class="timesheet-detail-container">
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading timesheet details...</p>
    </div>
  } @else if (timesheet()) {
    <!-- Header -->
    <div class="detail-header">
      <button mat-icon-button (click)="goBack()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-content">
        <h1>Timesheet Details</h1>
        <p class="subtitle">{{ getPeriodDisplay() }}</p>
      </div>
      <mat-chip [class]="'status-chip-' + getStatusColor(timesheet()!.status)">
        {{ getStatusLabel(timesheet()!.status) }}
      </mat-chip>
    </div>

    <!-- Summary Cards -->
    <div class="summary-grid">
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-icon regular">
            <mat-icon>access_time</mat-icon>
          </div>
          <div class="summary-details">
            <div class="summary-value">{{ formatHours(getTotalRegularHours()) }}</div>
            <div class="summary-label">Regular Hours</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-icon overtime">
            <mat-icon>schedule</mat-icon>
          </div>
          <div class="summary-details">
            <div class="summary-value">{{ formatHours(getTotalOvertimeHours()) }}</div>
            <div class="summary-label">Overtime Hours</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-icon holiday">
            <mat-icon>beach_access</mat-icon>
          </div>
          <div class="summary-details">
            <div class="summary-value">{{ formatHours(getTotalHolidayHours()) }}</div>
            <div class="summary-label">Holiday Hours</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-content>
          <div class="summary-icon leave">
            <mat-icon>event_busy</mat-icon>
          </div>
          <div class="summary-details">
            <div class="summary-value">{{ formatHours(getTotalLeaveHours()) }}</div>
            <div class="summary-label">Leave Hours</div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Payable Hours Banner -->
    <mat-card class="payable-banner">
      <mat-card-content>
        <div class="payable-content">
          <div class="payable-icon">
            <mat-icon>payments</mat-icon>
          </div>
          <div class="payable-details">
            <div class="payable-label">Total Payable Hours</div>
            <div class="payable-value">{{ formatHours(getTotalPayableHours()) }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Daily Entries Table -->
    <mat-card class="entries-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>calendar_today</mat-icon>
          Daily Breakdown
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="timesheet()!.entries || []" class="entries-table">

            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let entry">
                <div class="date-cell">
                  <strong>{{ formatDate(entry.date) }}</strong>
                </div>
              </td>
            </ng-container>

            <!-- Day Type Column -->
            <ng-container matColumnDef="dayType">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let entry">
                <span [class]="'day-type-badge ' + getDayTypeColor(entry.dayType)">
                  {{ getDayTypeLabel(entry.dayType) }}
                </span>
              </td>
            </ng-container>

            <!-- Clock In Column -->
            <ng-container matColumnDef="clockIn">
              <th mat-header-cell *matHeaderCellDef>Clock In</th>
              <td mat-cell *matCellDef="let entry">
                {{ formatTime(entry.clockInTime) }}
              </td>
            </ng-container>

            <!-- Clock Out Column -->
            <ng-container matColumnDef="clockOut">
              <th mat-header-cell *matHeaderCellDef>Clock Out</th>
              <td mat-cell *matCellDef="let entry">
                {{ formatTime(entry.clockOutTime) }}
              </td>
            </ng-container>

            <!-- Regular Hours Column -->
            <ng-container matColumnDef="regular">
              <th mat-header-cell *matHeaderCellDef>Regular</th>
              <td mat-cell *matCellDef="let entry">
                @if (entry.regularHours > 0) {
                  <span class="hours-value">{{ formatHours(entry.regularHours) }}</span>
                } @else {
                  <span class="no-hours">-</span>
                }
              </td>
            </ng-container>

            <!-- Overtime Column -->
            <ng-container matColumnDef="overtime">
              <th mat-header-cell *matHeaderCellDef>Overtime</th>
              <td mat-cell *matCellDef="let entry">
                @if (entry.overtimeHours > 0) {
                  <span class="hours-value overtime">{{ formatHours(entry.overtimeHours) }}</span>
                } @else {
                  <span class="no-hours">-</span>
                }
              </td>
            </ng-container>

            <!-- Total Column -->
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let entry">
                @if (getTotalHours(entry) > 0) {
                  <strong>{{ formatHours(getTotalHours(entry)) }}</strong>
                } @else {
                  <span class="no-hours">-</span>
                }
              </td>
            </ng-container>

            <!-- Notes Column -->
            <ng-container matColumnDef="notes">
              <th mat-header-cell *matHeaderCellDef>Notes</th>
              <td mat-cell *matCellDef="let entry">
                @if (entry.notes) {
                  <span class="notes-text" [matTooltip]="entry.notes">
                    {{ entry.notes.substring(0, 30) }}{{ entry.notes.length > 30 ? '...' : '' }}
                  </span>
                } @else {
                  <span class="no-hours">-</span>
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="entry-row"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Metadata Card -->
    <mat-card class="metadata-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info</mat-icon>
          Timesheet Information
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metadata-grid">
          <div class="metadata-item">
            <span class="metadata-label">Created:</span>
            <span class="metadata-value">{{ formatDate(timesheet()!.createdAt) }}</span>
          </div>

          @if (timesheet()!.submittedAt) {
            <div class="metadata-item">
              <span class="metadata-label">Submitted:</span>
              <span class="metadata-value">{{ formatDate(timesheet()!.submittedAt!) }}</span>
            </div>
          }

          @if (timesheet()!.approvedAt) {
            <div class="metadata-item">
              <span class="metadata-label">Approved:</span>
              <span class="metadata-value">{{ formatDate(timesheet()!.approvedAt!) }} by {{ timesheet()!.approvedByName }}</span>
            </div>
          }

          @if (timesheet()!.rejectedAt) {
            <div class="metadata-item">
              <span class="metadata-label">Rejected:</span>
              <span class="metadata-value">{{ formatDate(timesheet()!.rejectedAt!) }}</span>
            </div>
          }

          @if (timesheet()!.rejectionReason) {
            <div class="metadata-item full-width">
              <span class="metadata-label">Rejection Reason:</span>
              <span class="metadata-value rejection">{{ timesheet()!.rejectionReason }}</span>
            </div>
          }

          @if (timesheet()!.isLocked) {
            <div class="metadata-item">
              <span class="metadata-label">Status:</span>
              <span class="metadata-value locked">
                <mat-icon>lock</mat-icon>
                Locked
              </span>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Action Buttons -->
    <div class="action-container">
      <button mat-raised-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back to List
      </button>

      @if (canSubmit()) {
        <button mat-raised-button color="primary" (click)="submitTimesheet()">
          <mat-icon>send</mat-icon>
          Submit for Approval
        </button>
      }
    </div>
  }
</div>
