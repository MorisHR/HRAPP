<div class="leave-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>My Leave Requests</h1>
      <p class="subtitle">Apply for leave and track your requests</p>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="toggleForm()" [disabled]="loading()">
        <app-icon [name]="showForm() ? 'close' : 'add'"></app-icon>
        {{ showForm() ? 'Cancel' : 'Apply Leave' }}
      </button>
      <button mat-raised-button routerLink="/employee/dashboard" class="back-button">
        <app-icon name="arrow_back"></app-icon>
        Back
      </button>
    </div>
  </div>

  <!-- Leave Balance Cards -->
  <div class="balance-section">
    <h2 class="section-title">Leave Balance</h2>
    <div class="balance-grid">
      @for (balance of leaveBalances(); track balance.type) {
        <mat-card class="balance-card">
          <mat-card-content>
            <div class="balance-header">
              <h3>{{ getLeaveTypeLabel(balance.type) }}</h3>
              <app-chip
                [label]="balance.remaining + ' left'"
                [color]="getBalanceColor(getBalancePercentage(balance))"
                [variant]="'filled'">
              </app-chip>
            </div>
            <div class="balance-details">
              <div class="balance-bar">
                <div
                  class="balance-fill"
                  [style.width.%]="getBalancePercentage(balance)"
                  [class]="getBalanceColor(getBalancePercentage(balance))">
                </div>
              </div>
              <div class="balance-stats">
                <span>Used: <strong>{{ balance.used }}</strong></span>
                <span>Total: <strong>{{ balance.total }}</strong></span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      }
    </div>
  </div>

  <!-- Leave Application Form -->
  @if (showForm()) {
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>Apply for Leave</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="leaveForm" (ngSubmit)="onSubmit()" class="leave-form">
          <div class="form-row">
            <!-- Leave Type -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Leave Type</mat-label>
              <mat-select formControlName="leaveType">
                @for (type of leaveTypes; track type.value) {
                  <mat-option [value]="type.value">{{ type.label }}</mat-option>
                }
              </mat-select>
              <mat-error>Leave type is required</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <!-- Start Date -->
            <mat-form-field appearance="outline">
              <mat-label>Start Date</mat-label>
              <input matInput [matDatepicker]="startPicker" formControlName="startDate">
              <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
              <mat-error>Start date is required</mat-error>
            </mat-form-field>

            <!-- End Date -->
            <mat-form-field appearance="outline">
              <mat-label>End Date</mat-label>
              <input matInput [matDatepicker]="endPicker" formControlName="endDate">
              <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
              <mat-error>End date is required</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <!-- Reason -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Reason for Leave</mat-label>
              <textarea
                matInput
                formControlName="reason"
                rows="4"
                placeholder="Please provide a reason for your leave request (minimum 10 characters)"
                maxlength="500">
              </textarea>
              <mat-hint align="end">{{ leaveForm.get('reason')?.value?.length || 0 }}/500</mat-hint>
              <mat-error>
                @if (leaveForm.get('reason')?.hasError('required')) {
                  Reason is required
                }
                @if (leaveForm.get('reason')?.hasError('minlength')) {
                  Reason must be at least 10 characters
                }
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button
              type="submit"
              mat-raised-button
              color="primary"
              [disabled]="submitting() || leaveForm.invalid">
              @if (submitting()) {
                <app-progress-spinner size="small" color="primary" class="inline-spinner"></app-progress-spinner>
                Submitting...
              } @else {
                <app-icon name="send"></app-icon>
                Submit Request
              }
            </button>
            <button type="button" mat-button (click)="toggleForm()">Cancel</button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  }

  <!-- Stats Cards -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon info">
          <app-icon name="assignment"></app-icon>
        </div>
        <div class="stat-details">
          <div class="stat-value">{{ stats().total }}</div>
          <div class="stat-label">Total Requests</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon warning">
          <app-icon name="pending"></app-icon>
        </div>
        <div class="stat-details">
          <div class="stat-value">{{ stats().pending }}</div>
          <div class="stat-label">Pending</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon success">
          <app-icon name="check_circle"></app-icon>
        </div>
        <div class="stat-details">
          <div class="stat-value">{{ stats().approved }}</div>
          <div class="stat-label">Approved</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon error">
          <app-icon name="cancel"></app-icon>
        </div>
        <div class="stat-details">
          <div class="stat-value">{{ stats().rejected }}</div>
          <div class="stat-label">Rejected</div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Leave History -->
  <mat-card class="history-card">
    <mat-card-header>
      <mat-card-title>Leave History</mat-card-title>
      <button mat-icon-button (click)="loadLeaveData()" [disabled]="loading()">
        <app-icon name="refresh"></app-icon>
      </button>
    </mat-card-header>

    <mat-card-content>
      @if (loading()) {
        <div class="loading-state">
          <app-progress-spinner size="large" color="primary"></app-progress-spinner>
          <p>Loading leave requests...</p>
        </div>
      } @else if (leaveRequests().length === 0) {
        <div class="empty-state">
          <app-icon name="inbox"></app-icon>
          <p>No leave requests found</p>
          <button mat-raised-button color="primary" (click)="toggleForm()">
            Apply for Leave
          </button>
        </div>
      } @else {
        <div class="table-container">
          <app-table
            [columns]="columns"
            [data]="leaveRequests()"
            [loading]="loading()"
            [hoverable]="true"
            class="leave-table">

            <!-- Leave Type Column -->
            <ng-template appTableColumn="leaveType" let-request>
              {{ request.leaveType }}
            </ng-template>

            <!-- Dates Column -->
            <ng-template appTableColumn="dates" let-request>
              {{ formatDateRange(request.startDate, request.endDate) }}
            </ng-template>

            <!-- Days Column -->
            <ng-template appTableColumn="days" let-request>
              <strong>{{ request.days }}</strong> day{{ request.days > 1 ? 's' : '' }}
            </ng-template>

            <!-- Status Column -->
            <ng-template appTableColumn="status" let-request>
              <app-chip
                [label]="getStatusLabel(request.status)"
                [color]="getStatusColor(request.status)"
                [variant]="'filled'">
              </app-chip>
            </ng-template>

            <!-- Applied Date Column -->
            <ng-template appTableColumn="appliedDate" let-request>
              {{ formatDate(request.appliedDate) }}
            </ng-template>

            <!-- Actions Column -->
            <ng-template appTableColumn="actions" let-request>
              @if (request.status === 'pending') {
                <button
                  mat-icon-button
                  color="warn"
                  (click)="cancelRequest(request)"
                  appTooltip="Cancel request">
                  <app-icon name="cancel"></app-icon>
                </button>
              } @else {
                <span class="text-muted">-</span>
              }
            </ng-template>
          </app-table>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>
