<div class="subscription-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>Subscription Management</h1>
    <app-button variant="primary" (clicked)="refresh()">
      <app-icon name="refresh-cw"></app-icon>
      Refresh
    </app-button>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <app-progress-spinner size="medium" color="primary"></app-progress-spinner>
      <p>Loading subscription data...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <app-card class="error-card">
      <div class="card-content">
        <app-icon name="alert-circle" class="error-icon"></app-icon>
        <p>{{ error() }}</p>
        <app-button variant="ghost" (clicked)="refresh()">Retry</app-button>
      </div>
    </app-card>
  }

  <!-- Dashboard Content -->
  @if (!loading() && !error() && analytics()) {
    <!-- Revenue Analytics Cards -->
    <div class="analytics-cards">
      <app-card class="metric-card">
        <div class="card-header">
          <app-icon name="trending-up" class="metric-icon arr"></app-icon>
          <div class="metric-info">
            <span class="metric-subtitle">Annual Recurring Revenue</span>
            <h3 class="metric-title">{{ formatCurrency(analytics()!.arr) }}</h3>
          </div>
        </div>
      </app-card>

      <app-card class="metric-card">
        <div class="card-header">
          <app-icon name="dollar-sign" class="metric-icon mrr"></app-icon>
          <div class="metric-info">
            <span class="metric-subtitle">Monthly Recurring Revenue</span>
            <h3 class="metric-title">{{ formatCurrency(analytics()!.mrr) }}</h3>
          </div>
        </div>
      </app-card>

      <app-card class="metric-card">
        <div class="card-header">
          <app-icon name="activity" class="metric-icon churn"></app-icon>
          <div class="metric-info">
            <span class="metric-subtitle">Churn Rate</span>
            <h3 class="metric-title">{{ analytics()!.churnRate.toFixed(2) }}%</h3>
          </div>
        </div>
      </app-card>

      <app-card class="metric-card">
        <div class="card-header">
          <app-icon name="dollar-sign" class="metric-icon ltv"></app-icon>
          <div class="metric-info">
            <span class="metric-subtitle">Customer LTV</span>
            <h3 class="metric-title">{{ formatCurrency(analytics()!.ltv) }}</h3>
          </div>
        </div>
      </app-card>

      <app-card class="metric-card">
        <div class="card-header">
          <app-icon name="users" class="metric-icon active"></app-icon>
          <div class="metric-info">
            <span class="metric-subtitle">Active Subscriptions</span>
            <h3 class="metric-title">{{ analytics()!.totalActiveSubscriptions }}</h3>
          </div>
        </div>
      </app-card>

      <app-card class="metric-card">
        <div class="card-header">
          <app-icon name="wallet" class="metric-icon revenue"></app-icon>
          <div class="metric-info">
            <span class="metric-subtitle">Total Revenue</span>
            <h3 class="metric-title">{{ formatCurrency(analytics()!.totalRevenue) }}</h3>
          </div>
        </div>
      </app-card>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
      <!-- Revenue Trend Chart -->
      <app-card class="chart-card">
        <div class="card-header">
          <h3 class="card-title">Monthly Revenue Trend</h3>
        </div>
        <div class="card-content">
          @if (revenueChartData()) {
            <div class="chart-container">
              <canvas
                baseChart
                [data]="revenueChartData()!"
                [options]="revenueChartOptions"
                type="line">
              </canvas>
            </div>
          }
        </div>
      </app-card>

      <!-- Tier Distribution Chart -->
      <app-card class="chart-card">
        <div class="card-header">
          <h3 class="card-title">Subscription Tier Distribution</h3>
        </div>
        <div class="card-content">
          @if (tierChartData()) {
            <div class="chart-container">
              <canvas
                baseChart
                [data]="tierChartData()!"
                [options]="tierChartOptions"
                type="bar">
              </canvas>
            </div>
          }
        </div>
      </app-card>
    </div>

    <!-- Tabs for Different Views -->
    <app-card class="tabs-card">
      <app-tabs
        [tabs]="tabs()"
        [activeTab]="activeTab"
        (tabChange)="onTabChange($event)">

        <!-- Overdue Payments Tab -->
        <div *ngIf="activeTab === 'overdue'">

          @if (overduePayments().length === 0) {
            <div class="empty-state">
              <app-icon name="check_circle"></app-icon>
              <p>No overdue payments</p>
            </div>
          } @else {
            <div class="table-container">
              <app-table
                [data]="overduePayments()"
                [columns]="paymentColumns"
                [loading]="loading()"
                [hoverable]="true">

                <!-- Custom template for tenant column -->
                <ng-template appTableColumn="tenant" let-row>
                  <div class="tenant-cell">
                    <strong>{{ row.tenantName }}</strong>
                    <small>{{ row.tenantSubdomain }}</small>
                  </div>
                </ng-template>

                <!-- Custom template for amount column -->
                <ng-template appTableColumn="amount" let-row>
                  {{ formatCurrency(row.amount) }}
                </ng-template>

                <!-- Custom template for dueDate column -->
                <ng-template appTableColumn="dueDate" let-row>
                  <div class="date-cell">
                    <div>{{ formatDate(row.dueDate) }}</div>
                    <small class="overdue-text">{{ getDaysOverdue(row.dueDate) }} days overdue</small>
                  </div>
                </ng-template>

                <!-- Custom template for tier column -->
                <ng-template appTableColumn="tier" let-row>
                  <app-chip [label]="row.subscriptionTier" [color]="getTierColor(row.subscriptionTier)" />
                </ng-template>

                <!-- Custom template for status column -->
                <ng-template appTableColumn="status" let-row>
                  <app-chip [label]="row.status" [color]="getStatusColor(row.status)" />
                </ng-template>

                <!-- Custom template for actions column -->
                <ng-template appTableColumn="actions" let-row>
                  <div class="action-buttons">
                    <app-button
                      variant="ghost"
                      size="small"
                      appTooltip="Record Payment"
                      (clicked)="recordPayment(row.id)">
                      <app-icon name="payment"></app-icon>
                    </app-button>
                    <app-button
                      variant="ghost"
                      size="small"
                      appTooltip="Send Reminder"
                      (clicked)="sendReminder(row.id)">
                      <app-icon name="email"></app-icon>
                    </app-button>
                    <app-button
                      variant="ghost"
                      size="small"
                      appTooltip="View Details"
                      (clicked)="viewPaymentDetails(row)">
                      <app-icon name="visibility"></app-icon>
                    </app-button>
                  </div>
                </ng-template>
              </app-table>
            </div>
          }
        </div>

        <!-- Pending Payments Tab -->
        <div *ngIf="activeTab === 'pending'">

          @if (pendingPayments().length === 0) {
            <div class="empty-state">
              <app-icon name="check_circle"></app-icon>
              <p>No pending payments</p>
            </div>
          } @else {
            <div class="table-container">
              <app-table
                [data]="pendingPayments()"
                [columns]="paymentColumns"
                [loading]="loading()"
                [hoverable]="true">

                <!-- Custom template for tenant column -->
                <ng-template appTableColumn="tenant" let-row>
                  <div class="tenant-cell">
                    <strong>{{ row.tenantName }}</strong>
                    <small>{{ row.tenantSubdomain }}</small>
                  </div>
                </ng-template>

                <!-- Custom template for amount column -->
                <ng-template appTableColumn="amount" let-row>
                  {{ formatCurrency(row.amount) }}
                </ng-template>

                <!-- Custom template for dueDate column -->
                <ng-template appTableColumn="dueDate" let-row>
                  <div class="date-cell">
                    <div>{{ formatDate(row.dueDate) }}</div>
                    <small>{{ formatRelativeDate(row.dueDate) }}</small>
                  </div>
                </ng-template>

                <!-- Custom template for tier column -->
                <ng-template appTableColumn="tier" let-row>
                  <app-chip [label]="row.subscriptionTier" [color]="getTierColor(row.subscriptionTier)" />
                </ng-template>

                <!-- Custom template for status column -->
                <ng-template appTableColumn="status" let-row>
                  <app-chip [label]="row.status" [color]="getStatusColor(row.status)" />
                </ng-template>

                <!-- Custom template for actions column -->
                <ng-template appTableColumn="actions" let-row>
                  <div class="action-buttons">
                    <app-button
                      variant="ghost"
                      size="small"
                      appTooltip="Record Payment"
                      (clicked)="recordPayment(row.id)">
                      <app-icon name="payment"></app-icon>
                    </app-button>
                    <app-button
                      variant="ghost"
                      size="small"
                      appTooltip="Send Reminder"
                      (clicked)="sendReminder(row.id)">
                      <app-icon name="email"></app-icon>
                    </app-button>
                    <app-button
                      variant="ghost"
                      size="small"
                      appTooltip="View Details"
                      (clicked)="viewPaymentDetails(row)">
                      <app-icon name="visibility"></app-icon>
                    </app-button>
                  </div>
                </ng-template>
              </app-table>
            </div>
          }
        </div>

        <!-- Upcoming Renewals Tab -->
        <div *ngIf="activeTab === 'renewals'">

          @if (upcomingRenewals().length === 0) {
            <div class="empty-state">
              <app-icon name="event_available"></app-icon>
              <p>No upcoming renewals in the next 30 days</p>
            </div>
          } @else {
            <div class="table-container">
              <app-table
                [data]="upcomingRenewals()"
                [columns]="renewalColumns"
                [loading]="loading()"
                [hoverable]="true">

                <!-- Custom template for tenant column -->
                <ng-template appTableColumn="tenant" let-row>
                  <strong>{{ row.tenantName }}</strong>
                </ng-template>

                <!-- Custom template for renewalDate column -->
                <ng-template appTableColumn="renewalDate" let-row>
                  <div class="date-cell">
                    <div>{{ formatDate(row.renewalDate) }}</div>
                    <small>{{ formatRelativeDate(row.renewalDate) }}</small>
                  </div>
                </ng-template>

                <!-- Custom template for amount column -->
                <ng-template appTableColumn="amount" let-row>
                  {{ formatCurrency(row.amount) }}
                </ng-template>

                <!-- Custom template for tier column -->
                <ng-template appTableColumn="tier" let-row>
                  <app-chip [label]="row.tier" [color]="getTierColor(row.tier)" />
                </ng-template>

                <!-- Custom template for daysUntil column -->
                <ng-template appTableColumn="daysUntil" let-row>
                  <span class="days-badge">{{ row.daysUntilRenewal }}</span>
                </ng-template>
              </app-table>
            </div>
          }
        </div>

        <!-- Recently Suspended Tab -->
        <div *ngIf="activeTab === 'suspended'">
          @if (overview()?.recentlySuspendedTenants) {

            @if (overview()!.recentlySuspendedTenants.length === 0) {
              <div class="empty-state">
                <app-icon name="check_circle"></app-icon>
                <p>No recently suspended tenants</p>
              </div>
            } @else {
              <div class="suspended-list">
                @for (tenant of overview()!.recentlySuspendedTenants; track tenant.tenantId) {
                  <app-card class="suspended-card">
                    <div class="card-header">
                      <app-icon name="alert-octagon" class="suspended-icon"></app-icon>
                      <div class="suspended-info">
                        <h4 class="suspended-title">{{ tenant.tenantName }}</h4>
                        <span class="suspended-subtitle">Suspended {{ tenant.daysSuspended }} days ago</span>
                      </div>
                    </div>
                    <div class="card-content">
                      <p><strong>Overdue Amount:</strong> {{ formatCurrency(tenant.overdueAmount) }}</p>
                      <p><strong>Suspended Date:</strong> {{ formatDate(tenant.suspendedDate) }}</p>
                    </div>
                  </app-card>
                }
              </div>
            }
          }
        </div>
      </app-tabs>
    </app-card>
  }
</div>
