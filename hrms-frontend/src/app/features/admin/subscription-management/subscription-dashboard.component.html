<div class="subscription-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>Subscription Management</h1>
    <button mat-raised-button color="primary" (click)="refresh()">
      <app-icon name="refresh"></app-icon>
      Refresh
    </button>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <app-progress-spinner size="medium" color="primary"></app-progress-spinner>
      <p>Loading subscription data...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error() }}</p>
        <button mat-button color="primary" (click)="refresh()">Retry</button>
      </mat-card-content>
    </mat-card>
  }

  <!-- Dashboard Content -->
  @if (!loading() && !error() && analytics()) {
    <!-- Revenue Analytics Cards -->
    <div class="analytics-cards">
      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon class="metric-icon arr">trending_up</mat-icon>
          <div>
            <mat-card-subtitle>Annual Recurring Revenue</mat-card-subtitle>
            <mat-card-title>{{ formatCurrency(analytics()!.arr) }}</mat-card-title>
          </div>
        </mat-card-header>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon class="metric-icon mrr">attach_money</mat-icon>
          <div>
            <mat-card-subtitle>Monthly Recurring Revenue</mat-card-subtitle>
            <mat-card-title>{{ formatCurrency(analytics()!.mrr) }}</mat-card-title>
          </div>
        </mat-card-header>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon class="metric-icon churn">timeline</mat-icon>
          <div>
            <mat-card-subtitle>Churn Rate</mat-card-subtitle>
            <mat-card-title>{{ analytics()!.churnRate.toFixed(2) }}%</mat-card-title>
          </div>
        </mat-card-header>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon class="metric-icon ltv">monetization_on</mat-icon>
          <div>
            <mat-card-subtitle>Customer LTV</mat-card-subtitle>
            <mat-card-title>{{ formatCurrency(analytics()!.ltv) }}</mat-card-title>
          </div>
        </mat-card-header>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon class="metric-icon active">group</mat-icon>
          <div>
            <mat-card-subtitle>Active Subscriptions</mat-card-subtitle>
            <mat-card-title>{{ analytics()!.totalActiveSubscriptions }}</mat-card-title>
          </div>
        </mat-card-header>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon class="metric-icon revenue">account_balance</mat-icon>
          <div>
            <mat-card-subtitle>Total Revenue</mat-card-subtitle>
            <mat-card-title>{{ formatCurrency(analytics()!.totalRevenue) }}</mat-card-title>
          </div>
        </mat-card-header>
      </mat-card>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
      <!-- Revenue Trend Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Monthly Revenue Trend</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (revenueChartData()) {
            <div class="chart-container">
              <canvas
                baseChart
                [data]="revenueChartData()!"
                [options]="revenueChartOptions"
                type="line">
              </canvas>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Tier Distribution Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Subscription Tier Distribution</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (tierChartData()) {
            <div class="chart-container">
              <canvas
                baseChart
                [data]="tierChartData()!"
                [options]="tierChartOptions"
                type="bar">
              </canvas>
            </div>
          }
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Tabs for Different Views -->
    <mat-card class="tabs-card">
      <app-tabs
        [tabs]="tabs()"
        [activeTab]="activeTab"
        (tabChange)="onTabChange($event)">

        <!-- Overdue Payments Tab -->
        <div *ngIf="activeTab === 'overdue'">

          @if (overduePayments().length === 0) {
            <div class="empty-state">
              <app-icon name="check_circle"></app-icon>
              <p>No overdue payments</p>
            </div>
          } @else {
            <div class="table-container">
              <app-table
                [data]="overduePayments()"
                [columns]="paymentColumns"
                [loading]="loading()"
                [hoverable]="true">

                <!-- Custom template for tenant column -->
                <ng-template appTableColumn="tenant" let-row>
                  <div class="tenant-cell">
                    <strong>{{ row.tenantName }}</strong>
                    <small>{{ row.tenantSubdomain }}</small>
                  </div>
                </ng-template>

                <!-- Custom template for amount column -->
                <ng-template appTableColumn="amount" let-row>
                  {{ formatCurrency(row.amount) }}
                </ng-template>

                <!-- Custom template for dueDate column -->
                <ng-template appTableColumn="dueDate" let-row>
                  <div class="date-cell">
                    <div>{{ formatDate(row.dueDate) }}</div>
                    <small class="overdue-text">{{ getDaysOverdue(row.dueDate) }} days overdue</small>
                  </div>
                </ng-template>

                <!-- Custom template for tier column -->
                <ng-template appTableColumn="tier" let-row>
                  <app-chip [label]="row.subscriptionTier" [color]="getTierColor(row.subscriptionTier)" />
                </ng-template>

                <!-- Custom template for status column -->
                <ng-template appTableColumn="status" let-row>
                  <app-chip [label]="row.status" [color]="getStatusColor(row.status)" />
                </ng-template>

                <!-- Custom template for actions column -->
                <ng-template appTableColumn="actions" let-row>
                  <div class="action-buttons">
                    <button
                      mat-icon-button
                      color="primary"
                      appTooltip="Record Payment"
                      (click)="recordPayment(row.id)">
                      <app-icon name="payment"></app-icon>
                    </button>
                    <button
                      mat-icon-button
                      color="accent"
                      appTooltip="Send Reminder"
                      (click)="sendReminder(row.id)">
                      <app-icon name="email"></app-icon>
                    </button>
                    <button
                      mat-icon-button
                      appTooltip="View Details"
                      (click)="viewPaymentDetails(row)">
                      <app-icon name="visibility"></app-icon>
                    </button>
                  </div>
                </ng-template>
              </app-table>
            </div>
          }
        </div>

        <!-- Pending Payments Tab -->
        <div *ngIf="activeTab === 'pending'">

          @if (pendingPayments().length === 0) {
            <div class="empty-state">
              <app-icon name="check_circle"></app-icon>
              <p>No pending payments</p>
            </div>
          } @else {
            <div class="table-container">
              <app-table
                [data]="pendingPayments()"
                [columns]="paymentColumns"
                [loading]="loading()"
                [hoverable]="true">

                <!-- Custom template for tenant column -->
                <ng-template appTableColumn="tenant" let-row>
                  <div class="tenant-cell">
                    <strong>{{ row.tenantName }}</strong>
                    <small>{{ row.tenantSubdomain }}</small>
                  </div>
                </ng-template>

                <!-- Custom template for amount column -->
                <ng-template appTableColumn="amount" let-row>
                  {{ formatCurrency(row.amount) }}
                </ng-template>

                <!-- Custom template for dueDate column -->
                <ng-template appTableColumn="dueDate" let-row>
                  <div class="date-cell">
                    <div>{{ formatDate(row.dueDate) }}</div>
                    <small>{{ formatRelativeDate(row.dueDate) }}</small>
                  </div>
                </ng-template>

                <!-- Custom template for tier column -->
                <ng-template appTableColumn="tier" let-row>
                  <app-chip [label]="row.subscriptionTier" [color]="getTierColor(row.subscriptionTier)" />
                </ng-template>

                <!-- Custom template for status column -->
                <ng-template appTableColumn="status" let-row>
                  <app-chip [label]="row.status" [color]="getStatusColor(row.status)" />
                </ng-template>

                <!-- Custom template for actions column -->
                <ng-template appTableColumn="actions" let-row>
                  <div class="action-buttons">
                    <button
                      mat-icon-button
                      color="primary"
                      appTooltip="Record Payment"
                      (click)="recordPayment(row.id)">
                      <app-icon name="payment"></app-icon>
                    </button>
                    <button
                      mat-icon-button
                      color="accent"
                      appTooltip="Send Reminder"
                      (click)="sendReminder(row.id)">
                      <app-icon name="email"></app-icon>
                    </button>
                    <button
                      mat-icon-button
                      appTooltip="View Details"
                      (click)="viewPaymentDetails(row)">
                      <app-icon name="visibility"></app-icon>
                    </button>
                  </div>
                </ng-template>
              </app-table>
            </div>
          }
        </div>

        <!-- Upcoming Renewals Tab -->
        <div *ngIf="activeTab === 'renewals'">

          @if (upcomingRenewals().length === 0) {
            <div class="empty-state">
              <app-icon name="event_available"></app-icon>
              <p>No upcoming renewals in the next 30 days</p>
            </div>
          } @else {
            <div class="table-container">
              <app-table
                [data]="upcomingRenewals()"
                [columns]="renewalColumns"
                [loading]="loading()"
                [hoverable]="true">

                <!-- Custom template for tenant column -->
                <ng-template appTableColumn="tenant" let-row>
                  <strong>{{ row.tenantName }}</strong>
                </ng-template>

                <!-- Custom template for renewalDate column -->
                <ng-template appTableColumn="renewalDate" let-row>
                  <div class="date-cell">
                    <div>{{ formatDate(row.renewalDate) }}</div>
                    <small>{{ formatRelativeDate(row.renewalDate) }}</small>
                  </div>
                </ng-template>

                <!-- Custom template for amount column -->
                <ng-template appTableColumn="amount" let-row>
                  {{ formatCurrency(row.amount) }}
                </ng-template>

                <!-- Custom template for tier column -->
                <ng-template appTableColumn="tier" let-row>
                  <app-chip [label]="row.tier" [color]="getTierColor(row.tier)" />
                </ng-template>

                <!-- Custom template for daysUntil column -->
                <ng-template appTableColumn="daysUntil" let-row>
                  <span class="days-badge">{{ row.daysUntilRenewal }}</span>
                </ng-template>
              </app-table>
            </div>
          }
        </div>

        <!-- Recently Suspended Tab -->
        <div *ngIf="activeTab === 'suspended'">
          @if (overview()?.recentlySuspendedTenants) {

            @if (overview()!.recentlySuspendedTenants.length === 0) {
              <div class="empty-state">
                <app-icon name="check_circle"></app-icon>
                <p>No recently suspended tenants</p>
              </div>
            } @else {
              <div class="suspended-list">
                @for (tenant of overview()!.recentlySuspendedTenants; track tenant.tenantId) {
                  <mat-card class="suspended-card">
                    <mat-card-header>
                      <mat-icon mat-card-avatar color="warn">block</mat-icon>
                      <mat-card-title>{{ tenant.tenantName }}</mat-card-title>
                      <mat-card-subtitle>Suspended {{ tenant.daysSuspended }} days ago</mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content>
                      <p><strong>Overdue Amount:</strong> {{ formatCurrency(tenant.overdueAmount) }}</p>
                      <p><strong>Suspended Date:</strong> {{ formatDate(tenant.suspendedDate) }}</p>
                    </mat-card-content>
                  </mat-card>
                }
              </div>
            }
          }
        </div>
      </app-tabs>
    </mat-card>
  }
</div>
