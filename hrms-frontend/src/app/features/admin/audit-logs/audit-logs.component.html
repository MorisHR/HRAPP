<div class="audit-logs-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>System Audit Logs</h1>
      <p class="subtitle">Complete audit trail across all tenants</p>
    </div>
    <div class="header-actions">
      <app-button variant="ghost" (clicked)="refreshData()" [disabled]="loading">
        <app-icon name="refresh-cw"></app-icon>
        Refresh
      </app-button>
      <app-button variant="primary" (clicked)="exportLogs()" [disabled]="loading">
        <app-icon name="download"></app-icon>
        Export CSV
      </app-button>
    </div>
  </div>

  <!-- Tabs -->
  <app-tabs
    [tabs]="tabs"
    [activeTab]="activeTab"
    (tabChange)="onTabChange($event)">

    <!-- Audit Logs Tab -->
    <div *ngIf="activeTab === 'logs'">
      <!-- Filter Panel -->
      <div class="filter-panel">
        <app-expansion-panel>
          <div panel-title>
            <app-icon name="filter_list"></app-icon>
            Filters
          </div>

          <div class="filter-content">
            <div class="filter-row">
              <!-- Date Range -->
              <mat-form-field appearance="outline">
                <mat-label>Start Date</mat-label>
                <input matInput [matDatepicker]="startPicker" [(ngModel)]="filter.startDate" (dateChange)="onFilterChange({startDate: $event.value})">
                <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>End Date</mat-label>
                <input matInput [matDatepicker]="endPicker" [(ngModel)]="filter.endDate" (dateChange)="onFilterChange({endDate: $event.value})">
                <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
              </mat-form-field>

              <!-- User Email Search -->
              <mat-form-field appearance="outline">
                <mat-label>User Email</mat-label>
                <input matInput [(ngModel)]="filter.userEmail" (ngModelChange)="onFilterChange({userEmail: $event})">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>

              <!-- Entity Type -->
              <mat-form-field appearance="outline">
                <mat-label>Entity Type</mat-label>
                <input matInput [(ngModel)]="filter.entityType" (ngModelChange)="onFilterChange({entityType: $event})">
              </mat-form-field>
            </div>

            <div class="filter-actions">
              <app-button variant="ghost" (clicked)="clearFilters()">Clear All</app-button>
              <app-button variant="primary" (clicked)="loadAuditLogs()">Apply Filters</app-button>
            </div>
          </div>
        </app-expansion-panel>
      </div>

      <!-- Table -->
      <div class="table-container">
        @if (!loading && auditLogs.length > 0) {
          <div class="table-wrapper">
            <app-table
              [data]="auditLogs"
              [columns]="columns"
              [loading]="loading"
              [hoverable]="true">

              <!-- Custom template for performedAt column -->
              <ng-template appTableColumn="performedAt" let-row>
                <div class="timestamp">
                  <div class="date">{{ row.performedAt | date:'short' }}</div>
                  <div class="relative">{{ getRelativeTime(row.performedAt) }}</div>
                </div>
              </ng-template>

              <!-- Custom template for tenantName column -->
              <ng-template appTableColumn="tenantName" let-row>
                <span class="tenant-name">{{ row.tenantName || 'System' }}</span>
              </ng-template>

              <!-- Custom template for userEmail column -->
              <ng-template appTableColumn="userEmail" let-row>
                <div class="user-info">
                  <div class="user-avatar">{{ row.userEmail?.charAt(0)?.toUpperCase() || 'S' }}</div>
                  <div class="user-details">
                    <div class="email">{{ row.userEmail || 'System' }}</div>
                    @if (row.userRole) {
                      <div class="role">{{ row.userRole }}</div>
                    }
                  </div>
                </div>
              </ng-template>

              <!-- Custom template for actionType column -->
              <ng-template appTableColumn="actionType" let-row>
                <span class="action-badge">{{ row.actionTypeName }}</span>
              </ng-template>

              <!-- Custom template for category column -->
              <ng-template appTableColumn="category" let-row>
                <span class="category-badge" [ngClass]="getCategoryClass(row.category)">
                  {{ row.categoryName }}
                </span>
              </ng-template>

              <!-- Custom template for severity column -->
              <ng-template appTableColumn="severity" let-row>
                <span class="severity-badge" [ngClass]="getSeverityClass(row.severity)">
                  <app-icon [name]="row.severity === 1 ? 'info' : row.severity === 2 ? 'warning' : 'error'"></app-icon>
                  {{ row.severityName }}
                </span>
              </ng-template>

              <!-- Custom template for entityType column -->
              <ng-template appTableColumn="entityType" let-row>
                {{ row.entityType || '-' }}
              </ng-template>

              <!-- Custom template for success column -->
              <ng-template appTableColumn="success" let-row>
                <app-icon [attr.name]="row.success ? 'check-circle' : 'x-circle'" [class.success]="row.success" [class.failed]="!row.success">
                </app-icon>
              </ng-template>

              <!-- Custom template for actions column -->
              <ng-template appTableColumn="actions" let-row>
                <app-button variant="ghost" size="small" (clicked)="viewDetails(row)" appTooltip="View Details">
                  <app-icon name="eye"></app-icon>
                </app-button>
              </ng-template>
            </app-table>

            <!-- Paginator -->
            <app-paginator
              [length]="totalCount"
              [pageSize]="pageSize"
              [pageSizeOptions]="pageSizeOptions"
              [pageIndex]="pageNumber - 1"
              (page)="onPageChange($event)"
              [showFirstLastButtons]="true">
            </app-paginator>
          </div>
        }

        <!-- Loading State -->
        @if (loading) {
          <div class="loading-state">
            <app-progress-spinner size="large" color="primary"></app-progress-spinner>
            <p>Loading audit logs...</p>
          </div>
        }

        <!-- Empty State -->
        @if (!loading && auditLogs.length === 0) {
          <div class="empty-state">
            <app-icon name="history"></app-icon>
            <h3>No Audit Logs Found</h3>
            <p>Try adjusting your filters or date range</p>
          </div>
        }
      </div>
    </div>

    <!-- Statistics Tab -->
    <div *ngIf="activeTab === 'statistics'">
      @if (!loadingStats && statistics) {
        <div class="statistics-container">
          <div class="stats-grid">
            <!-- Summary Cards -->
            <app-card class="stat-card">
              <div class="card-header">
                <app-icon name="analytics"></app-icon>
                <h3 class="card-title">Total Actions</h3>
              </div>
              <div class="card-content">
                <div class="stat-value">{{ statistics.totalActions | number }}</div>
                <div class="stat-label">All time</div>
              </div>
            </app-card>
            <app-card class="stat-card">
              <div class="card-header">
                <app-icon name="today"></app-icon>
                <h3 class="card-title">Today</h3>
              </div>
              <div class="card-content">
                <div class="stat-value">{{ statistics.actionsToday | number }}</div>
                <div class="stat-label">Actions</div>
              </div>
            </app-card>
            <app-card class="stat-card warning">
              <div class="card-header">
                <app-icon name="lock"></app-icon>
                <h3 class="card-title">Failed Logins</h3>
              </div>
              <div class="card-content">
                <div class="stat-value">{{ statistics.failedLogins | number }}</div>
                <div class="stat-label">Security alerts</div>
              </div>
            </app-card>
            <app-card class="stat-card critical">
              <div class="card-header">
                <app-icon name="error"></app-icon>
                <h3 class="card-title">Critical Events</h3>
              </div>
              <div class="card-content">
                <div class="stat-value">{{ statistics.criticalEvents | number }}</div>
                <div class="stat-label">Requires attention</div>
              </div>
            </app-card>
          </div>
          <!-- Most Active Users -->
          <app-card class="activity-card">
            <div class="card-header">
              <h3 class="card-title">Most Active Users</h3>
            </div>
            <div class="card-content">
              @if (statistics.mostActiveUsers.length > 0) {
                <div class="user-list">
                  @for (user of statistics.mostActiveUsers; track user) {
                    <div class="user-item">
                      <div class="user-avatar">{{ user.userEmail.charAt(0).toUpperCase() }}</div>
                      <div class="user-info">
                        <div class="user-email">{{ user.userEmail }}</div>
                        <div class="user-stats">{{ user.actionCount }} actions</div>
                      </div>
                      <div class="last-activity">{{ user.lastActivity | date:'short' }}</div>
                    </div>
                  }
                </div>
              }
              @if (statistics.mostActiveUsers.length === 0) {
                <div class="no-data">
                  No activity data available
                </div>
              }
            </div>
          </app-card>
        </div>
      }

      <!-- Loading State -->
      @if (loadingStats) {
        <div class="loading-state">
          <app-progress-spinner size="large" color="primary"></app-progress-spinner>
          <p>Loading statistics...</p>
        </div>
      }
    </div>
  </app-tabs>
</div>
