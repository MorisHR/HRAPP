<div class="anomaly-dashboard">
  <h1>Anomaly Detection Dashboard</h1>

  <!-- Statistics Cards -->
  @if (statistics) {
    <div class="statistics-grid">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Total Anomalies</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-value">{{ statistics.totalAnomalies }}</div>
          <div class="stat-label">Last 30 Days</div>
        </mat-card-content>
      </mat-card>
      <mat-card>
        <mat-card-header>
          <mat-card-title>New Anomalies</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-value warn-text">{{ statistics.newAnomalies }}</div>
          <div class="stat-label">Requiring Investigation</div>
        </mat-card-content>
      </mat-card>
      <mat-card>
        <mat-card-header>
          <mat-card-title>Critical Threats</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-value error-text">{{ statistics.criticalAnomalies }}</div>
          <div class="stat-label">High Priority</div>
        </mat-card-content>
      </mat-card>
      <mat-card>
        <mat-card-header>
          <mat-card-title>Average Risk Score</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-value">{{ statistics.averageRiskScore.toFixed(1) }}</div>
          <div class="stat-label">Out of 100</div>
        </mat-card-content>
      </mat-card>
    </div>
  }

  <!-- Anomalies Table -->
  <mat-card class="anomalies-card">
    <mat-card-header>
      <mat-card-title>Detected Anomalies</mat-card-title>
      <div class="filters">
        <mat-form-field appearance="outline">
          <mat-label>Filter by Status</mat-label>
          <mat-select [(ngModel)]="selectedStatus" (selectionChange)="onStatusFilterChange()">
            <mat-option [value]="undefined">All Statuses</mat-option>
            @for (status of statusOptions; track status) {
              <mat-option [value]="status">
                {{ status }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-header>

    <mat-card-content>
      @if (loading) {
        <div class="loading-container">
          <app-progress-spinner size="medium" color="primary"></app-progress-spinner>
        </div>
      }

      @if (!loading) {
        <app-table
          [data]="anomalies"
          [columns]="columns"
          [loading]="loading"
          [hoverable]="true">

          <!-- Custom template for detectedAt column -->
          <ng-template appTableColumn="detectedAt" let-row>
            {{ row.detectedAt | date:'short' }}
          </ng-template>

          <!-- Custom template for anomalyType column -->
          <ng-template appTableColumn="anomalyType" let-row>
            <app-chip [label]="row.anomalyType" [color]="'neutral'" />
          </ng-template>

          <!-- Custom template for riskLevel column -->
          <ng-template appTableColumn="riskLevel" let-row>
            <app-chip [label]="row.riskLevel + ' (' + row.riskScore + ')'" [color]="getRiskLevelColor(row.riskLevel)" />
          </ng-template>

          <!-- Custom template for userEmail column -->
          <ng-template appTableColumn="userEmail" let-row>
            {{ row.userEmail || 'Unknown' }}
          </ng-template>

          <!-- Custom template for description column -->
          <ng-template appTableColumn="description" let-row>
            <span [appTooltip]="row.description">
              {{ row.description.substring(0, 50) }}{{ row.description.length > 50 ? '...' : '' }}
            </span>
          </ng-template>

          <!-- Custom template for status column -->
          <ng-template appTableColumn="status" let-row>
            <app-chip [label]="row.status" [color]="getStatusColor(row.status)" />
          </ng-template>

          <!-- Custom template for actions column -->
          <ng-template appTableColumn="actions" let-row>
            <button mat-icon-button (click)="viewDetails(row)" appTooltip="View Details">
              <app-icon name="visibility"></app-icon>
            </button>
            @if (row.status === 'NEW') {
              <button mat-icon-button (click)="startInvestigation(row)"
                appTooltip="Start Investigation">
                <app-icon name="search"></app-icon>
              </button>
            }
            @if (row.status !== 'FALSE_POSITIVE' && row.status !== 'RESOLVED') {
              <button mat-icon-button (click)="markAsFalsePositive(row)"
                appTooltip="Mark as False Positive">
                <app-icon name="cancel"></app-icon>
              </button>
            }
            @if (row.status === 'INVESTIGATING') {
              <button mat-icon-button (click)="resolveAnomaly(row)"
                appTooltip="Resolve">
                <app-icon name="check_circle"></app-icon>
              </button>
            }
          </ng-template>
        </app-table>
      }

      <app-paginator
        [length]="totalCount"
        [pageSize]="pageSize"
        [pageSizeOptions]="[10, 20, 50, 100]"
        (page)="onPageChange($event)"
        [showFirstLastButtons]="true">
      </app-paginator>
    </mat-card-content>
  </mat-card>
</div>
