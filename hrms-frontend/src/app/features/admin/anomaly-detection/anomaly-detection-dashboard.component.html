<div class="anomaly-dashboard">
  <h1>Anomaly Detection Dashboard</h1>

  <!-- Statistics Cards -->
  @if (statistics) {
    <div class="statistics-grid">
      <app-card>
        <div class="card-header">
          <h3 class="card-title">Total Anomalies</h3>
        </div>
        <div class="card-content">
          <div class="stat-value">{{ statistics.totalAnomalies }}</div>
          <div class="stat-label">Last 30 Days</div>
        </div>
      </app-card>
      <app-card>
        <div class="card-header">
          <h3 class="card-title">New Anomalies</h3>
        </div>
        <div class="card-content">
          <div class="stat-value warn-text">{{ statistics.newAnomalies }}</div>
          <div class="stat-label">Requiring Investigation</div>
        </div>
      </app-card>
      <app-card>
        <div class="card-header">
          <h3 class="card-title">Critical Threats</h3>
        </div>
        <div class="card-content">
          <div class="stat-value error-text">{{ statistics.criticalAnomalies }}</div>
          <div class="stat-label">High Priority</div>
        </div>
      </app-card>
      <app-card>
        <div class="card-header">
          <h3 class="card-title">Average Risk Score</h3>
        </div>
        <div class="card-content">
          <div class="stat-value">{{ statistics.averageRiskScore.toFixed(1) }}</div>
          <div class="stat-label">Out of 100</div>
        </div>
      </app-card>
    </div>
  }

  <!-- Anomalies Table -->
  <app-card class="anomalies-card">
    <div class="card-header">
      <h3 class="card-title">Detected Anomalies</h3>
      <div class="filters">
        <app-select
          label="Filter by Status"
          [(ngModel)]="selectedStatus"
          (ngModelChange)="onStatusFilterChange()"
          [options]="statusSelectOptions">
        </app-select>
      </div>
    </div>

    <div class="card-content">
      @if (loading) {
        <div class="loading-container">
          <app-progress-spinner size="medium" color="primary"></app-progress-spinner>
        </div>
      }

      @if (!loading) {
        <app-table
          [data]="anomalies"
          [columns]="columns"
          [loading]="loading"
          [hoverable]="true">

          <!-- Custom template for detectedAt column -->
          <ng-template appTableColumn="detectedAt" let-row>
            {{ row.detectedAt | date:'short' }}
          </ng-template>

          <!-- Custom template for anomalyType column -->
          <ng-template appTableColumn="anomalyType" let-row>
            <app-chip [label]="row.anomalyType" [color]="'neutral'" />
          </ng-template>

          <!-- Custom template for riskLevel column -->
          <ng-template appTableColumn="riskLevel" let-row>
            <app-chip [label]="row.riskLevel + ' (' + row.riskScore + ')'" [color]="getRiskLevelColor(row.riskLevel)" />
          </ng-template>

          <!-- Custom template for userEmail column -->
          <ng-template appTableColumn="userEmail" let-row>
            {{ row.userEmail || 'Unknown' }}
          </ng-template>

          <!-- Custom template for description column -->
          <ng-template appTableColumn="description" let-row>
            <span [appTooltip]="row.description">
              {{ row.description.substring(0, 50) }}{{ row.description.length > 50 ? '...' : '' }}
            </span>
          </ng-template>

          <!-- Custom template for status column -->
          <ng-template appTableColumn="status" let-row>
            <app-chip [label]="row.status" [color]="getStatusColor(row.status)" />
          </ng-template>

          <!-- Custom template for actions column -->
          <ng-template appTableColumn="actions" let-row>
            <app-button variant="ghost" size="small" (clicked)="viewDetails(row)" appTooltip="View Details">
              <app-icon name="eye"></app-icon>
            </app-button>
            @if (row.status === 'NEW') {
              <app-button variant="ghost" size="small" (clicked)="startInvestigation(row)"
                appTooltip="Start Investigation">
                <app-icon name="search"></app-icon>
              </app-button>
            }
            @if (row.status !== 'FALSE_POSITIVE' && row.status !== 'RESOLVED') {
              <app-button variant="ghost" size="small" (clicked)="markAsFalsePositive(row)"
                appTooltip="Mark as False Positive">
                <app-icon name="x-circle"></app-icon>
              </app-button>
            }
            @if (row.status === 'INVESTIGATING') {
              <app-button variant="ghost" size="small" (clicked)="resolveAnomaly(row)"
                appTooltip="Resolve">
                <app-icon name="check-circle"></app-icon>
              </app-button>
            }
          </ng-template>
        </app-table>
      }

      <app-paginator
        [length]="totalCount"
        [pageSize]="pageSize"
        [pageSizeOptions]="[10, 20, 50, 100]"
        (page)="onPageChange($event)"
        [showFirstLastButtons]="true">
      </app-paginator>
    </div>
  </app-card>
</div>
