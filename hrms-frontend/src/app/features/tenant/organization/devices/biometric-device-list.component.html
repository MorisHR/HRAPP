<mat-card>
  <mat-card-header>
    <mat-card-title>Biometric Devices</mat-card-title>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="onRefresh()" class="refresh-button">
        <app-icon name="refresh"></app-icon>
        Refresh
      </button>
      <button mat-raised-button color="primary" (click)="onAdd()" class="add-button">
        <app-icon name="add"></app-icon>
        Add Device
      </button>
    </div>
  </mat-card-header>

  <mat-card-content>
    <!-- Loading Spinner -->
    @if (loading()) {
      <div class="loading-container">
        <app-progress-spinner size="medium" color="primary"></app-progress-spinner>
        <p>Loading attendance machines...</p>
      </div>
    }

    <!-- Error Message -->
    @if (error()) {
      <div class="error-container">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error() }}</p>
      </div>
    }

    <!-- Devices Table -->
    @if (!loading() && !error()) {
      <app-table
        [columns]="columns"
        [data]="machines()"
        [loading]="loading()"
        [hoverable]="true"
        class="devices-table">

        <!-- Custom template for device code column -->
        <ng-template appTableColumn="code" let-row>
          <div class="device-code">
            <mat-icon class="device-icon">fingerprint</mat-icon>
            <span>{{ row.machineId }}</span>
          </div>
        </ng-template>

        <!-- Custom template for device name column -->
        <ng-template appTableColumn="name" let-row>
          <div class="device-name">
            <strong>{{ row.machineName }}</strong>
            <span class="device-type">{{ row.model || 'Biometric Device' }}</span>
          </div>
        </ng-template>

        <!-- Custom template for location column -->
        <ng-template appTableColumn="location" let-row>
          <div class="location-info">
            <mat-icon class="location-icon">location_on</mat-icon>
            <span>{{ row.location || row.departmentName || 'Unassigned' }}</span>
          </div>
        </ng-template>

        <!-- Custom template for IP address column -->
        <ng-template appTableColumn="ipAddress" let-row>
          <div class="ip-address">
            <mat-icon class="network-icon">router</mat-icon>
            <span class="ip-text">{{ row.ipAddress || 'N/A' }}</span>
            @if (row.ipAddress) {
              <span class="port-text">:{{ row.port }}</span>
            }
          </div>
        </ng-template>

        <!-- Custom template for status column -->
        <ng-template appTableColumn="status" let-row>
          <div class="status-badge-wrapper">
            <span
              class="device-status-badge"
              [class.online]="getDeviceStatusClass(row) === 'online'"
              [class.warning]="getDeviceStatusClass(row) === 'warning'"
              [class.offline]="getDeviceStatusClass(row) === 'offline'">
              <span class="status-dot"></span>
              {{ getDeviceStatusText(row) }}
            </span>
          </div>
        </ng-template>

        <!-- Custom template for last sync column -->
        <ng-template appTableColumn="lastSync" let-row>
          <div class="last-sync-info">
            <mat-icon class="sync-icon">schedule</mat-icon>
            <div class="sync-details">
              <span class="sync-time">{{ getLastSyncDisplay(row.lastSyncAt) }}</span>
            </div>
          </div>
        </ng-template>

        <!-- Custom template for actions column -->
        <ng-template appTableColumn="actions" let-row>
          <div class="action-buttons">
            <!-- Test Connection Button -->
            <button
              mat-icon-button
              (click)="onTestConnection(row)"
              [disabled]="isTestingConnection(row.id)"
              appTooltip="Test Connection"
              class="test-button"
              color="accent">
              @if (isTestingConnection(row.id)) {
                <app-icon name="sync"></app-icon>
              } @else {
                <app-icon name="wifi_tethering"></app-icon>
              }
            </button>
            <!-- Sync Now Button -->
            <button
              mat-icon-button
              (click)="onSyncNow(row)"
              [disabled]="isSyncing(row.id) || !row.isActive"
              appTooltip="Sync Now"
              class="sync-button"
              color="primary">
              @if (isSyncing(row.id)) {
                <app-icon name="sync"></app-icon>
              } @else {
                <app-icon name="cloud_sync"></app-icon>
              }
            </button>
            <!-- Edit Button -->
            <button
              mat-icon-button
              (click)="onEdit(row.id)"
              appTooltip="Edit Device"
              class="edit-button">
              <app-icon name="edit"></app-icon>
            </button>
            <!-- Delete Button -->
            <button
              mat-icon-button
              color="warn"
              (click)="onDelete(row.id, row.machineName)"
              appTooltip="Delete Device"
              class="delete-button">
              <app-icon name="delete"></app-icon>
            </button>
          </div>
        </ng-template>
      </app-table>

      <!-- Empty State -->
      @if (machines().length === 0) {
        <div class="empty-state">
          <mat-icon class="empty-icon">devices</mat-icon>
          <h3>No Biometric Devices Registered</h3>
          <p>Click "Add Device" to register your first biometric attendance device.</p>
          <button mat-raised-button color="primary" (click)="onAdd()">
            <app-icon name="add"></app-icon>
            Add Your First Device
          </button>
        </div>
      }
    }

    <!-- Device Statistics Summary -->
    @if (!loading() && !error() && machines().length) {
      <div class="statistics-summary">
        <div class="stat-card">
          <app-icon name="devices"></app-icon>
          <div class="stat-info">
            <span class="stat-label">Total Machines</span>
            <span class="stat-value">{{ machines().length || 0 }}</span>
          </div>
        </div>
        <div class="stat-card online">
          <app-icon name="check_circle"></app-icon>
          <div class="stat-info">
            <span class="stat-label">Online</span>
            <span class="stat-value">{{ getOnlineDeviceCount() }}</span>
          </div>
        </div>
        <div class="stat-card warning">
          <app-icon name="warning"></app-icon>
          <div class="stat-info">
            <span class="stat-label">Warning</span>
            <span class="stat-value">{{ getWarningDeviceCount() }}</span>
          </div>
        </div>
        <div class="stat-card offline">
          <app-icon name="cancel"></app-icon>
          <div class="stat-info">
            <span class="stat-label">Offline</span>
            <span class="stat-value">{{ getOfflineDeviceCount() }}</span>
          </div>
        </div>
      </div>
    }
  </mat-card-content>
</mat-card>
