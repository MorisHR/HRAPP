<mat-card class="api-keys-card">
  <mat-card-header>
    <mat-card-title>
      <app-icon name="vpn_key"></app-icon>
      API Key Management
    </mat-card-title>
    <div class="header-actions">
      <button
        mat-icon-button
        (click)="onRefresh()"
        [disabled]="loading()"
        appTooltip="Refresh">
        <app-icon name="refresh"></app-icon>
      </button>
      <button
        mat-raised-button
        color="primary"
        (click)="onGenerateNewKey()"
        [disabled]="loading()">
        <app-icon name="add"></app-icon>
        Generate New API Key
      </button>
    </div>
  </mat-card-header>

  <mat-card-content>
    <!-- Loading State -->
    @if (loading()) {
      <div class="loading-container">
        <app-progress-spinner size="medium" color="primary"></app-progress-spinner>
        <p>Loading API keys...</p>
      </div>
    }

    <!-- Error State -->
    @if (error() && !loading()) {
      <div class="error-container">
        <app-icon name="error"></app-icon>
        <p>{{ error() }}</p>
        <button mat-raised-button color="primary" (click)="onRefresh()">
          <app-icon name="refresh"></app-icon>
          Retry
        </button>
      </div>
    }

    <!-- Empty State -->
    @if (!loading() && !error() && apiKeys().length === 0) {
      <div class="empty-container">
        <app-icon name="vpn_key"></app-icon>
        <h3>No API Keys Yet</h3>
        <p>Generate an API key to enable programmatic access to this device.</p>
        <button
          mat-raised-button
          color="primary"
          (click)="onGenerateNewKey()">
          <app-icon name="add"></app-icon>
          Generate First API Key
        </button>
      </div>
    }

    <!-- API Keys Table -->
    @if (!loading() && !error() && apiKeys().length > 0) {
      <app-table
        [columns]="tableColumns"
        [data]="apiKeys()"
        [loading]="loading()"
        [hoverable]="true"
        [striped]="true">

        <!-- Description Template -->
        <ng-template appTableColumn="description" let-row>
          <div class="description-cell">
            <app-icon name="description"></app-icon>
            <span>{{ row.description }}</span>
          </div>
        </ng-template>

        <!-- Status Template -->
        <ng-template appTableColumn="status" let-row>
          <app-chip [label]="getStatusText(row)" [color]="getStatusClass(row) === 'status-active' ? 'success' : getStatusClass(row) === 'status-expired' ? 'error' : getStatusClass(row) === 'status-expiring' ? 'warning' : 'neutral'" />
        </ng-template>

        <!-- Date Template -->
        <ng-template appTableColumn="createdAt" let-row>
          <div class="date-cell">
            <app-icon name="calendar_today"></app-icon>
            <span>{{ formatDate(row.createdAt) }}</span>
          </div>
        </ng-template>

        <!-- Expires Template -->
        <ng-template appTableColumn="expiresAt" let-row>
          <div class="date-cell">
            <app-icon name="event"></app-icon>
            <span>{{ formatDate(row.expiresAt) }}</span>
          </div>
        </ng-template>

        <!-- Last Used Template -->
        <ng-template appTableColumn="lastUsedAt" let-row>
          <div class="date-cell">
            <app-icon name="access_time"></app-icon>
            <span>{{ formatDate(row.lastUsedAt) }}</span>
          </div>
        </ng-template>

        <!-- Usage Template -->
        <ng-template appTableColumn="usageCount" let-row>
          <div class="usage-cell">
            <app-icon name="trending_up"></app-icon>
            <span>{{ row.usageCount }}</span>
          </div>
        </ng-template>

        <!-- Actions Template -->
        <ng-template appTableColumn="actions" let-row>
          <div class="actions-cell">
            @if (row.isActive) {
              <button
                mat-icon-button
                (click)="onRotate(row)"
                appTooltip="Rotate API key">
                <app-icon name="sync"></app-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="onRevoke(row)"
                appTooltip="Revoke API key">
                <app-icon name="block"></app-icon>
              </button>
            }
            @if (!row.isActive) {
              <span class="revoked-badge">Revoked</span>
            }
          </div>
        </ng-template>
      </app-table>

      <!-- Info Box -->
      <div class="info-box">
        <app-icon name="info"></app-icon>
        <div>
          <strong>API Key Security Best Practices:</strong>
          <ul>
            <li>Store API keys securely and never commit them to version control</li>
            <li>Rotate keys periodically and when team members leave</li>
            <li>Use different keys for different environments (dev, staging, production)</li>
            <li>Revoke keys immediately if they are compromised</li>
            <li>Monitor usage counts to detect unauthorized access</li>
          </ul>
        </div>
      </div>
    }
  </mat-card-content>
</mat-card>
