<mat-card>
  <mat-card-header>
    <mat-card-title>{{ getPageTitle() }}</mat-card-title>
    <div class="header-actions">
      <button
        mat-raised-button
        color="primary"
        (click)="onTestConnection()"
        [disabled]="testingConnection || !isNetworkConfigRequired() || getControl('ipAddress')?.invalid"
        class="test-connection-button"
        >
        @if (testingConnection) {
          <mat-spinner diameter="20"></mat-spinner>
        }
        @if (!testingConnection) {
          <app-icon name="wifi_tethering"></app-icon>
        }
        Test Connection
      </button>
    </div>
  </mat-card-header>

  <mat-card-content>
    <!-- Loading State -->
    @if (loading) {
      <div class="loading-container">
        <mat-spinner></mat-spinner>
        <p>Loading device information...</p>
      </div>
    }

    <!-- Form -->
    @if (!loading) {
      <form [formGroup]="deviceForm" (ngSubmit)="onSubmit()" class="device-form">
        <!-- ============================================ -->
        <!-- SECTION 1: DEVICE INFORMATION -->
        <!-- ============================================ -->
        <div class="form-section">
          <div class="section-header">
            <app-icon name="info"></app-icon>
            <h3>Device Information</h3>
          </div>
          <div class="form-grid">
            <!-- Device Code -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Device Code <span class="required">*</span></mat-label>
              <input matInput formControlName="deviceCode" placeholder="e.g., BIO-001">
              <mat-icon matPrefix>fingerprint</mat-icon>
              @if (hasError('deviceCode', 'required')) {
                <mat-error>
                  Device code is required
                </mat-error>
              }
              @if (hasError('deviceCode', 'maxlength')) {
                <mat-error>
                  Maximum 50 characters allowed
                </mat-error>
              }
              <mat-hint>Unique identifier for this device</mat-hint>
            </mat-form-field>
            <!-- Machine Name -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Machine Name <span class="required">*</span></mat-label>
              <input matInput formControlName="machineName" placeholder="e.g., Main Entrance Scanner">
              <mat-icon matPrefix>devices</mat-icon>
              @if (hasError('machineName', 'required')) {
                <mat-error>
                  Machine name is required
                </mat-error>
              }
              @if (hasError('machineName', 'maxlength')) {
                <mat-error>
                  Maximum 100 characters allowed
                </mat-error>
              }
            </mat-form-field>
            <!-- Location -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Location <span class="required">*</span></mat-label>
              <mat-select formControlName="locationId" placeholder="Select location">
                @for (location of locations; track location) {
                  <mat-option [value]="location.id">
                    {{ location.locationName }} ({{ location.locationCode }})
                  </mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>location_on</mat-icon>
              @if (hasError('locationId', 'required')) {
                <mat-error>
                  Location is required
                </mat-error>
              }
              @if (loadingLocations) {
                <mat-hint>Loading locations...</mat-hint>
              }
            </mat-form-field>
            <!-- Device Type -->
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Device Type <span class="required">*</span></mat-label>
              <mat-select formControlName="deviceType">
                @for (type of deviceTypes; track type) {
                  <mat-option [value]="type.value">
                    {{ type.label }}
                  </mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>category</mat-icon>
            </mat-form-field>
            <!-- Model -->
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Model</mat-label>
              <input matInput formControlName="model" placeholder="e.g., F18, K40">
              <mat-icon matPrefix>model_training</mat-icon>
              <mat-hint>Optional</mat-hint>
            </mat-form-field>
          </div>
        </div>
        <mat-divider></mat-divider>
        <!-- ============================================ -->
        <!-- SECTION 2: NETWORK CONFIGURATION (HIGHLIGHT) -->
        <!-- ============================================ -->
        <div class="form-section network-section">
          <div class="section-header highlighted">
            <app-icon name="router"></app-icon>
            <h3>Network Configuration</h3>
            <span class="badge important">Critical</span>
          </div>
          <div class="form-grid">
            <!-- Connection Method -->
            <div class="full-width radio-group-container">
              <label class="radio-group-label">Connection Method <span class="required">*</span></label>
              <mat-radio-group formControlName="connectionMethod" class="radio-group">
                @for (method of connectionMethods; track method) {
                  <mat-radio-button [value]="method.value">
                    {{ method.label }}
                  </mat-radio-button>
                }
              </mat-radio-group>
            </div>
            <!-- IP Address -->
            @if (isNetworkConfigRequired()) {
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>IP Address <span class="required">*</span></mat-label>
                <input matInput formControlName="ipAddress" placeholder="192.168.1.100">
                <mat-icon matPrefix>public</mat-icon>
                @if (hasError('ipAddress', 'required')) {
                  <mat-error>
                    IP address is required for network connection
                  </mat-error>
                }
                @if (hasError('ipAddress', 'pattern')) {
                  <mat-error>
                    Valid IP format required (e.g., 192.168.1.100)
                  </mat-error>
                }
                @if (hasError('ipAddress', 'invalidIp')) {
                  <mat-error>
                    Invalid IP address. Each segment must be 0-255
                  </mat-error>
                }
                <mat-hint>Device network IP address</mat-hint>
              </mat-form-field>
            }
            <!-- Port -->
            @if (isNetworkConfigRequired()) {
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Port <span class="required">*</span></mat-label>
                <input matInput type="number" formControlName="port" placeholder="4370">
                <mat-icon matPrefix>settings_ethernet</mat-icon>
                @if (hasError('port', 'required')) {
                  <mat-error>
                    Port is required
                  </mat-error>
                }
                @if (hasError('port', 'min') || hasError('port', 'max')) {
                  <mat-error>
                    Port must be between 1 and 65535
                  </mat-error>
                }
                <mat-hint>Default: 4370 for ZKTeco devices</mat-hint>
              </mat-form-field>
            }
            <!-- MAC Address -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>MAC Address</mat-label>
              <input matInput formControlName="macAddress" placeholder="00:17:61:01:23:45">
              <mat-icon matPrefix>settings_input_antenna</mat-icon>
              @if (hasError('macAddress', 'pattern')) {
                <mat-error>
                  Invalid MAC address format. Use XX:XX:XX:XX:XX:XX
                </mat-error>
              }
              <mat-hint>Format: XX:XX:XX:XX:XX:XX (Optional)</mat-hint>
            </mat-form-field>
            <!-- Network Configuration Info Box -->
            <div class="info-box full-width">
              <app-icon name="info"></app-icon>
              <div class="info-content">
                <strong>Network Setup Tips:</strong>
                <ul>
                  <li>Ensure the device is powered on and connected to your network</li>
                  <li>Configure your network to allow communication on the specified port</li>
                  <li>Use static IP addresses for better reliability</li>
                  <li>Test the connection before saving to verify connectivity</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <mat-divider></mat-divider>
        <!-- ============================================ -->
        <!-- SECTION 3: DEVICE CREDENTIALS (OPTIONAL) -->
        <!-- ============================================ -->
        <div class="form-section">
          <div class="section-header">
            <app-icon name="lock"></app-icon>
            <h3>Device Credentials</h3>
            <span class="badge optional">Optional</span>
          </div>
          <div class="form-grid">
            <!-- Username -->
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Username</mat-label>
              <input matInput formControlName="username" placeholder="admin">
              <mat-icon matPrefix>person</mat-icon>
              <mat-hint>Device admin username (if required)</mat-hint>
            </mat-form-field>
            <!-- Password -->
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Password</mat-label>
              <input
                matInput
                [type]="hidePassword ? 'password' : 'text'"
                formControlName="password"
                placeholder="Enter password"
                >
                <mat-icon matPrefix>vpn_key</mat-icon>
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  (click)="hidePassword = !hidePassword"
                  [attr.aria-label]="'Hide password'"
                  [attr.aria-pressed]="hidePassword"
                  >
                  <app-icon [name]="hidePassword ? 'visibility_off' : 'visibility'"></app-icon>
                </button>
                <mat-hint>Device admin password (if required)</mat-hint>
              </mat-form-field>
            </div>
          </div>
          <mat-divider></mat-divider>
          <!-- ============================================ -->
          <!-- SECTION 4: SYNC SETTINGS -->
          <!-- ============================================ -->
          <div class="form-section">
            <div class="section-header">
              <app-icon name="sync"></app-icon>
              <h3>Synchronization Settings</h3>
            </div>
            <div class="form-grid">
              <!-- Enable Auto-Sync -->
              <div class="full-width toggle-container">
                <mat-slide-toggle formControlName="syncEnabled" color="primary">
                  <strong>Enable Automatic Synchronization</strong>
                </mat-slide-toggle>
                <p class="toggle-hint">Automatically fetch attendance records from this device</p>
              </div>
              <!-- Sync Interval -->
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Sync Interval (Minutes) <span class="required">*</span></mat-label>
                <input matInput type="number" formControlName="syncIntervalMinutes" placeholder="15">
                <mat-icon matPrefix>schedule</mat-icon>
                <mat-error>{{ getErrorMessage('syncIntervalMinutes') }}</mat-error>
                <mat-hint>How often to sync (1-1440 minutes). Recommended: 15</mat-hint>
              </mat-form-field>
              <!-- Connection Timeout -->
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Connection Timeout (Seconds) <span class="required">*</span></mat-label>
                <input matInput type="number" formControlName="connectionTimeoutSeconds" placeholder="30">
                <mat-icon matPrefix>timer</mat-icon>
                <mat-error>{{ getErrorMessage('connectionTimeoutSeconds') }}</mat-error>
                <mat-hint>Max wait time for connection (5-300 seconds)</mat-hint>
              </mat-form-field>
              <!-- Enable Offline Alerts -->
              <div class="full-width toggle-container">
                <mat-slide-toggle formControlName="offlineAlertEnabled" color="accent">
                  <strong>Enable Offline Alerts</strong>
                </mat-slide-toggle>
                <p class="toggle-hint">Receive notifications when device goes offline</p>
              </div>
              <!-- Offline Threshold -->
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Offline Threshold (Minutes) <span class="required">*</span></mat-label>
                <input matInput type="number" formControlName="offlineThresholdMinutes" placeholder="60">
                <mat-icon matPrefix>notifications_active</mat-icon>
                <mat-error>{{ getErrorMessage('offlineThresholdMinutes') }}</mat-error>
                <mat-hint>Alert if no sync for this duration (5-1440 minutes)</mat-hint>
              </mat-form-field>
            </div>
          </div>
          <mat-divider></mat-divider>
          <!-- ============================================ -->
          <!-- SECTION 5: DEVICE IDENTIFICATION (OPTIONAL) -->
          <!-- ============================================ -->
          <div class="form-section collapsible-section">
            <div class="section-header">
              <app-icon name="badge"></app-icon>
              <h3>Device Identification</h3>
              <span class="badge optional">Optional</span>
            </div>
            <div class="form-grid">
              <!-- Serial Number -->
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Serial Number</mat-label>
                <input matInput formControlName="serialNumber" placeholder="e.g., ZK2023001">
                <mat-icon matPrefix>qr_code</mat-icon>
                <mat-hint>Device serial number</mat-hint>
              </mat-form-field>
              <!-- Firmware Version -->
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Firmware Version</mat-label>
                <input matInput formControlName="firmwareVersion" placeholder="e.g., 6.60">
                <mat-icon matPrefix>system_update</mat-icon>
                <mat-hint>Current firmware version</mat-hint>
              </mat-form-field>
            </div>
          </div>
          <mat-divider></mat-divider>
          <!-- ============================================ -->
          <!-- ACTION BUTTONS -->
          <!-- ============================================ -->
          <div class="form-actions">
            <div class="left-actions">
              <button
                mat-button
                type="button"
                (click)="onCancel()"
                [disabled]="savingDevice"
                class="cancel-button"
                >
                <app-icon name="close"></app-icon>
                Cancel
              </button>
            </div>
            <div class="right-actions">
              <button
                mat-raised-button
                color="primary"
                type="button"
                (click)="onTestConnection()"
                [disabled]="testingConnection || savingDevice || !isNetworkConfigRequired() || getControl('ipAddress')?.invalid"
                class="test-button"
                >
                @if (testingConnection) {
                  <mat-spinner diameter="20"></mat-spinner>
                }
                @if (!testingConnection) {
                  <app-icon name="wifi_tethering"></app-icon>
                }
                {{ testingConnection ? 'Testing...' : 'Test Connection' }}
              </button>
              <button
                mat-raised-button
                color="primary"
                type="submit"
                [disabled]="deviceForm.invalid || savingDevice || testingConnection"
                class="submit-button"
                >
                @if (savingDevice) {
                  <mat-spinner diameter="20"></mat-spinner>
                }
                @if (!savingDevice) {
                  <app-icon name="save"></app-icon>
                }
                {{ savingDevice ? 'Saving...' : getSubmitButtonText() }}
              </button>
            </div>
          </div>
          <!-- Form Validation Summary -->
          @if (deviceForm.invalid && deviceForm.touched) {
            <div class="validation-summary">
              <app-icon name="error"></app-icon>
              <span>Please fix the validation errors above before submitting</span>
            </div>
          }
        </form>
      }
    </mat-card-content>
  </mat-card>

  <!-- API Key Management Section (Only shown in edit mode) -->
  @if (isEditMode && deviceId) {
    <app-device-api-keys [deviceId]="deviceId"></app-device-api-keys>
  }
