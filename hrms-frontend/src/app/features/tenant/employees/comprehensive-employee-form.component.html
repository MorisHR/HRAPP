<div class="employee-form-container">
  <mat-card class="form-card">
    <!-- Header -->
    <mat-card-header>
      <div class="header-content">
        <button mat-icon-button routerLink="/tenant/employees" class="back-button">
          <app-icon name="arrow_back"></app-icon>
        </button>
        <div class="header-text">
          <h1>{{ isEditMode() ? 'Edit Employee' : 'Add New Employee' }}</h1>
          <p class="subtitle">Complete all required fields to register employee</p>
        </div>
      </div>
    </mat-card-header>

    <!-- Progress Bar -->
    <div class="progress-section">
      <div class="progress-header">
        <span class="progress-label">Completion Progress</span>
        <span class="progress-percentage">{{ completionPercentage() }}%</span>
      </div>
      <mat-progress-bar
        mode="determinate"
        [value]="completionPercentage()"
        [color]="completionPercentage() === 100 ? 'primary' : 'accent'">
      </mat-progress-bar>
      <div class="save-status">
        <app-icon [name]="saving() ? 'cloud_upload' : 'cloud_done'" [class.saving]="saving()"></app-icon>
        <span>{{ getSaveStatusText() }}</span>
      </div>
    </div>

    <!-- Error Message -->
    @if (error()) {
      <div class="error-banner">
        <app-icon name="error"></app-icon>
        <span>{{ error() }}</span>
      </div>
    }

    <mat-card-content>
      <form [formGroup]="employeeForm" (ngSubmit)="onSubmit()">
        <app-expansion-panel-group [multi]="true">

          <!-- ========== SECTION 1: PERSONAL INFORMATION ========== -->
          <app-expansion-panel [expanded]="personalInfoExpanded">
            <div panel-title>
              <app-icon
                [name]="getSectionIcon(personalInfoFields)"
                [class]="getSectionIconClass(personalInfoFields)">
              </app-icon>
              Personal Information - Basic employee details
            </div>

            <div class="form-grid">
              <app-input
                label="First Name *"
                placeholder="John"
                formControlName="firstName"
                [required]="true"
                [error]="getFieldError('firstName')">
              </app-input>

              <app-input
                label="Last Name *"
                placeholder="Doe"
                formControlName="lastName"
                [required]="true"
                [error]="getFieldError('lastName')">
              </app-input>

              <app-datepicker
                label="Date of Birth *"
                formControlName="dateOfBirth"
                [required]="true"
                [error]="getFieldError('dateOfBirth')">
              </app-datepicker>

              <app-select
                label="Gender *"
                placeholder="Select gender"
                formControlName="gender"
                [options]="genderOptions"
                [required]="true"
                [error]="getFieldError('gender')">
              </app-select>

              <app-select
                label="Nationality *"
                placeholder="Select nationality"
                formControlName="nationality"
                [options]="nationalityOptions"
                [required]="true"
                [error]="getFieldError('nationality')">
              </app-select>

              <app-input
                label="National Identity Card (NIC) *"
                placeholder="A1234567890123"
                formControlName="nic"
                hint="Mauritius NIC format"
                [required]="true"
                [error]="getFieldError('nic')">
              </app-input>

              <app-input
                label="Phone Number *"
                type="tel"
                placeholder="+230 5123 4567"
                formControlName="phoneNumber"
                [required]="true"
                [error]="getFieldError('phoneNumber')">
              </app-input>

              <app-input
                label="Email Address *"
                type="email"
                placeholder="john.doe@company.mu"
                formControlName="email"
                [required]="true"
                [error]="getFieldError('email')">
              </app-input>

              <app-input
                label="Alternate Email"
                type="email"
                formControlName="alternateEmail"
                [error]="getFieldError('alternateEmail')">
              </app-input>

              <app-select
                label="Blood Group"
                placeholder="Select blood group"
                formControlName="bloodGroup"
                [options]="bloodGroupOptions">
              </app-select>

              <!-- Mauritius Address Section -->
              <div class="address-section full-width">
                <h4 class="subsection-title">Residential Address (Mauritius)</h4>
                <div class="form-grid">
                  <app-select
                    label="District *"
                    placeholder="Select district first"
                    formControlName="district"
                    [options]="districtOptions"
                    hint="Select district first"
                    [required]="true"
                    [error]="getFieldError('district')"
                    (valueChange)="onDistrictChange($event)">
                  </app-select>

                  <app-select
                    label="Village/Locality"
                    placeholder="Select district first"
                    formControlName="village"
                    [options]="villageOptions"
                    hint="Optional - auto-filled by postal code">
                  </app-select>

                  <app-input
                    label="Postal Code"
                    placeholder="11302"
                    formControlName="postalCode"
                    hint="Enter postal code to auto-fill address"
                    (blur)="onPostalCodeBlur(employeeForm.get('postalCode')?.value)">
                  </app-input>

                  <app-input
                    label="City/Town"
                    placeholder="Port Louis"
                    formControlName="city"
                    hint="Auto-filled from postal code">
                  </app-input>

                  <app-input
                    class="full-width"
                    label="Address Line 1 *"
                    placeholder="House/Building number, Street name"
                    formControlName="addressLine1"
                    [required]="true"
                    [error]="getFieldError('addressLine1')">
                  </app-input>

                  <app-input
                    class="full-width"
                    label="Address Line 2"
                    placeholder="Additional address details (optional)"
                    formControlName="addressLine2">
                  </app-input>

                  <app-input
                    label="Region"
                    placeholder="e.g., North, South"
                    formControlName="region"
                    hint="Auto-filled from postal code">
                  </app-input>

                  <app-select
                    label="Country *"
                    placeholder="Select country"
                    formControlName="country"
                    [options]="countryOptions"
                    [required]="true"
                    [error]="getFieldError('country')">
                  </app-select>
                </div>
              </div>

              <!-- Expatriate-specific fields -->
              @if (isExpatriate()) {
                <div class="expatriate-section full-width">
                  <h4 class="subsection-title">Expatriate Documents</h4>
                  <div class="form-grid">
                    <app-input
                      label="Passport Number *"
                      formControlName="passportNumber"
                      [required]="true"
                      [error]="getFieldError('passportNumber')">
                    </app-input>

                    <app-datepicker
                      label="Passport Expiry Date *"
                      formControlName="passportExpiryDate"
                      [required]="true"
                      [error]="getFieldError('passportExpiryDate')">
                    </app-datepicker>

                    <app-input
                      label="Visa Number *"
                      formControlName="visaNumber"
                      [required]="true"
                      [error]="getFieldError('visaNumber')">
                    </app-input>

                    <app-datepicker
                      label="Visa Expiry Date"
                      formControlName="visaExpiryDate">
                    </app-datepicker>

                    <app-input
                      label="Work Permit Number *"
                      formControlName="workPermitNumber"
                      [required]="true"
                      [error]="getFieldError('workPermitNumber')">
                    </app-input>

                    <app-datepicker
                      label="Work Permit Expiry Date"
                      formControlName="workPermitExpiryDate">
                    </app-datepicker>

                    <app-select
                      label="Work Permit Type"
                      placeholder="Select permit type"
                      formControlName="workPermitType"
                      [options]="workPermitTypeOptions">
                    </app-select>

                    <app-input
                      label="Residence Permit Number"
                      formControlName="residencePermitNumber">
                    </app-input>
                  </div>
                </div>
              }

              <!-- ========== INTELLIGENCE INSIGHTS (Rule-based, NO AI) ========== -->
              <div class="intelligence-insights full-width">
                <h4 class="subsection-title">
                  <app-icon name="auto_awesome"></app-icon>
                  Smart Insights (Rule-based Assistant)
                </h4>

                <!-- Passport Detection Result -->
                @if (passportDetectionResult() && passportDetectionResult()!.detectedNationality) {
                  <div class="insight-card passport-detection" [class]="'confidence-' + passportDetectionResult()!.confidence">
                    <div class="insight-header">
                      <app-icon name="card_travel"></app-icon>
                      <strong>Passport Detected</strong>
                      <app-chip
                        [label]="passportDetectionResult()!.confidence + ' confidence'"
                        [color]="passportDetectionResult()!.confidence === 'high' ? 'success' : 'warning'"
                        [variant]="'filled'">
                      </app-chip>
                    </div>
                    <p>Detected nationality: <strong>{{ passportDetectionResult()!.detectedNationality }}</strong></p>
                    <p class="pattern-info">Pattern: {{ passportDetectionResult()!.pattern }}</p>
                  </div>
                }

                <!-- Work Permit Recommendation -->
                @if (workPermitRecommendation()) {
                  <div class="insight-card work-permit" [class]="'priority-' + workPermitRecommendation()!.priority">
                    <div class="insight-header">
                      <app-icon name="work"></app-icon>
                      <strong>Work Permit Recommendation</strong>
                      <app-chip
                        [label]="workPermitRecommendation()!.priority + ' priority'"
                        [color]="workPermitRecommendation()!.priority === 'high' ? 'error' : workPermitRecommendation()!.priority === 'medium' ? 'warning' : 'primary'"
                        [variant]="'filled'">
                      </app-chip>
                    </div>
                    <p><strong>Recommended Type:</strong> {{ workPermitRecommendation()!.recommendedType }}</p>
                    <p><strong>Reason:</strong> {{ workPermitRecommendation()!.reason }}</p>
                    <ul class="requirements-list">
                      @for (req of workPermitRecommendation()!.requirements; track req) {
                        <li>{{ req }}</li>
                      }
                    </ul>
                    <p class="processing-time"><app-icon name="schedule"></app-icon> Processing time: {{ workPermitRecommendation()!.estimatedProcessingTime }}</p>
                  </div>
                }

                <!-- Expiry Alerts -->
                @if (expiryAlerts() && expiryAlerts().length > 0) {
                  <div class="insight-card expiry-alerts">
                    <div class="insight-header">
                      <app-icon name="warning"></app-icon>
                      <strong>Document Expiry Alerts</strong>
                    </div>
                    @for (alert of expiryAlerts(); track alert.documentType) {
                      <div class="alert-item" [class]="'severity-' + alert.severity">
                        <div class="alert-info">
                          <app-chip
                            [label]="alert.severity"
                            [color]="alert.severity === 'critical' ? 'error' : alert.severity === 'warning' ? 'warning' : 'primary'"
                            [variant]="'filled'">
                          </app-chip>
                          <span><strong>{{ alert.documentType }}:</strong> {{ alert.message }}</span>
                        </div>
                        <span class="days-remaining">{{ alert.daysUntilExpiry }} days</span>
                      </div>
                    }
                  </div>
                }

                <!-- Tax Calculation Preview -->
                @if (taxCalculation()) {
                  <div class="insight-card tax-calculation">
                    <div class="insight-header">
                      <app-icon name="account_balance"></app-icon>
                      <strong>Tax Liability Estimate</strong>
                    </div>
                    <div class="tax-summary">
                      <div class="tax-row">
                        <span>Annual Salary:</span>
                        <strong>{{ formatCurrency(taxCalculation()!.annualSalary) }}</strong>
                      </div>
                      <div class="tax-row">
                        <span>Tax Rate:</span>
                        <strong>{{ (taxCalculation()!.effectiveRate * 100).toFixed(2) }}%</strong>
                      </div>
                      <div class="tax-row primary">
                        <span>Annual Tax:</span>
                        <strong>{{ formatCurrency(taxCalculation()!.totalTax) }}</strong>
                      </div>
                      <div class="tax-row">
                        <span>Monthly Tax:</span>
                        <strong>{{ formatCurrency(taxCalculation()!.totalTax / 12) }}</strong>
                      </div>
                    </div>
                    @if (taxCalculation()!.treatyBenefit && taxCalculation()!.treatyBenefit > 0) {
                      <div class="treaty-benefit">
                        <app-icon name="savings"></app-icon>
                        <span>Treaty Benefit: {{ formatCurrency(taxCalculation()!.treatyBenefit) }} annual savings!</span>
                      </div>
                    }
                  </div>
                }

                <!-- Sector Compliance -->
                @if (sectorCompliance() && !sectorCompliance()!.isCompliant) {
                  <div class="insight-card sector-compliance warning">
                    <div class="insight-header">
                      <app-icon name="report_problem"></app-icon>
                      <strong>Sector Compliance Issues</strong>
                    </div>
                    <ul class="violations-list">
                      @for (violation of sectorCompliance()!.violations; track violation) {
                        <li>
                          <app-icon name="error"></app-icon>
                          {{ violation }}
                        </li>
                      }
                    </ul>
                    <div class="recommendations">
                      <strong>Recommendations:</strong>
                      <ul>
                        @for (rec of sectorCompliance()!.recommendations; track rec) {
                          <li>{{ rec }}</li>
                        }
                      </ul>
                    </div>
                  </div>
                }

                <!-- Leave Balance Prediction -->
                @if (leaveBalancePrediction()) {
                  <div class="insight-card leave-balance" [class]="'risk-' + leaveBalancePrediction()!.riskLevel">
                    <div class="insight-header">
                      <app-icon name="event_available"></app-icon>
                      <strong>Leave Balance Prediction</strong>
                      <app-chip
                        [label]="leaveBalancePrediction()!.riskLevel + ' risk'"
                        [color]="leaveBalancePrediction()!.riskLevel === 'high' ? 'error' : leaveBalancePrediction()!.riskLevel === 'medium' ? 'warning' : 'success'"
                        [variant]="'filled'">
                      </app-chip>
                    </div>

                    <!-- Current Status -->
                    <div class="leave-summary">
                      <div class="summary-row">
                        <span>Current Balance:</span>
                        <strong>{{ leaveBalancePrediction()!.currentBalance.toFixed(1) }} days</strong>
                      </div>
                      <div class="summary-row">
                        <span>Annual Entitlement:</span>
                        <strong>{{ leaveBalancePrediction()!.annualEntitlement.toFixed(1) }} days</strong>
                      </div>
                      <div class="summary-row">
                        <span>Used This Year:</span>
                        <strong>{{ leaveBalancePrediction()!.usedThisYear.toFixed(1) }} days</strong>
                      </div>
                      <div class="summary-row highlight">
                        <span>Year-End Prediction:</span>
                        <strong>{{ leaveBalancePrediction()!.predictedYearEndBalance.toFixed(1) }} days</strong>
                      </div>
                      <div class="summary-row">
                        <span>Utilization Rate:</span>
                        <strong>{{ leaveBalancePrediction()!.utilizationRate.toFixed(1) }}%</strong>
                      </div>
                    </div>

                    <!-- Risk Message -->
                    <div class="risk-message" [class]="'risk-' + leaveBalancePrediction()!.riskLevel">
                      <app-icon name="info"></app-icon>
                      <span>{{ leaveBalancePrediction()!.riskMessage }}</span>
                    </div>

                    <!-- Expiring Leave Warning -->
                    @if (leaveBalancePrediction()!.expiringLeave && leaveBalancePrediction()!.expiringLeave! > 0) {
                      <div class="expiring-warning">
                        <app-icon name="warning"></app-icon>
                        <strong>{{ leaveBalancePrediction()!.expiringLeave }} days will expire</strong> if not used by year-end!
                      </div>
                    }

                    <!-- Public Holidays -->
                    @if (leaveBalancePrediction()!.publicHolidaysRemaining > 0) {
                      <div class="public-holidays">
                        <app-icon name="celebration"></app-icon>
                        <span><strong>{{ leaveBalancePrediction()!.publicHolidaysRemaining }}</strong> public holidays remaining this year</span>
                      </div>
                    }

                    <!-- Recommendations -->
                    @if (leaveBalancePrediction()!.recommendations.length > 0) {
                      <div class="recommendations-section">
                        <strong>Recommendations:</strong>
                        <ul class="recommendations-list">
                          @for (rec of leaveBalancePrediction()!.recommendations; track rec) {
                            <li>{{ rec }}</li>
                          }
                        </ul>
                      </div>
                    }

                    <!-- Suggested Leave Schedule -->
                    @if (leaveBalancePrediction()!.suggestedLeaveSchedule.length > 0) {
                      <div class="leave-schedule">
                        <strong>Suggested Leave Schedule:</strong>
                        <div class="schedule-items">
                          @for (schedule of leaveBalancePrediction()!.suggestedLeaveSchedule; track schedule.month) {
                            <div class="schedule-item" [class]="'priority-' + schedule.priority">
                              <div class="schedule-header">
                                <app-chip
                                  [label]="schedule.priority"
                                  [color]="schedule.priority === 'high' ? 'error' : schedule.priority === 'medium' ? 'warning' : 'primary'"
                                  [variant]="'outlined'"
                                  size="small">
                                </app-chip>
                                <span class="month">{{ schedule.month }}</span>
                                <span class="days">{{ schedule.suggestedDays }} days</span>
                              </div>
                              <p class="reason">{{ schedule.reason }}</p>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- Probation Period Calculation -->
                @if (probationCalculation()) {
                  <div class="insight-card probation-period" [class]="'urgency-' + probationCalculation()!.urgency">
                    <div class="insight-header">
                      <app-icon name="schedule"></app-icon>
                      <strong>Probation Period Tracker</strong>
                      <app-chip
                        [label]="probationCalculation()!.status"
                        [color]="probationCalculation()!.urgency === 'critical' ? 'error' : probationCalculation()!.urgency === 'high' ? 'warning' : 'primary'"
                        [variant]="'filled'">
                      </app-chip>
                    </div>

                    <!-- Status Message -->
                    <div class="probation-status">
                      <app-icon name="info"></app-icon>
                      <p>{{ probationCalculation()!.statusMessage }}</p>
                    </div>

                    <!-- Progress Bar -->
                    <div class="probation-progress">
                      <div class="progress-header">
                        <span>Progress</span>
                        <strong>{{ probationCalculation()!.progressPercentage.toFixed(0) }}%</strong>
                      </div>
                      <div class="progress-bar-container">
                        <div class="progress-bar" [style.width.%]="probationCalculation()!.progressPercentage"></div>
                      </div>
                      <div class="progress-details">
                        <span>{{ probationCalculation()!.daysElapsed }} days elapsed</span>
                        <span>{{ probationCalculation()!.daysRemaining }} days remaining</span>
                      </div>
                    </div>

                    <!-- Dates -->
                    <div class="probation-dates">
                      <div class="date-item">
                        <app-icon name="event"></app-icon>
                        <div>
                          <span class="label">Start Date</span>
                          <strong>{{ probationCalculation()!.probationStartDate | date: 'mediumDate' }}</strong>
                        </div>
                      </div>
                      <div class="date-item">
                        <app-icon name="event_available"></app-icon>
                        <div>
                          <span class="label">End Date</span>
                          <strong>{{ probationCalculation()!.probationEndDate | date: 'mediumDate' }}</strong>
                        </div>
                      </div>
                    </div>

                    <!-- Alerts -->
                    @if (probationCalculation()!.alerts.length > 0) {
                      <div class="probation-alerts">
                        <strong>Alerts:</strong>
                        @for (alert of probationCalculation()!.alerts; track alert.message) {
                          <div class="alert-item" [class]="'severity-' + alert.severity">
                            <app-icon [name]="alert.icon"></app-icon>
                            <div class="alert-content">
                              <p class="alert-message">{{ alert.message }}</p>
                              <p class="alert-action">{{ alert.actionRequired }}</p>
                            </div>
                          </div>
                        }
                      </div>
                    }

                    <!-- Review Milestones -->
                    @if (probationCalculation()!.reviewMilestones.length > 0) {
                      <div class="review-milestones">
                        <strong>Review Milestones:</strong>
                        <div class="milestones-timeline">
                          @for (milestone of probationCalculation()!.reviewMilestones; track milestone.id) {
                            <div class="milestone-item"
                                 [class.completed]="milestone.isCompleted"
                                 [class.overdue]="milestone.isOverdue"
                                 [class.pending]="milestone.isPending">
                              <div class="milestone-icon">
                                <app-icon [name]="milestone.isCompleted ? 'check_circle' : milestone.isOverdue ? 'error' : 'schedule'"></app-icon>
                              </div>
                              <div class="milestone-details">
                                <div class="milestone-header">
                                  <strong>{{ milestone.name }}</strong>
                                  <app-chip
                                    [label]="milestone.isOverdue ? 'OVERDUE' : milestone.isPending ? 'DUE SOON' : milestone.daysUntil + ' days'"
                                    [color]="milestone.isOverdue ? 'error' : milestone.isPending ? 'warning' : 'primary'"
                                    [variant]="'outlined'"
                                    size="small">
                                  </app-chip>
                                </div>
                                <p class="milestone-date">{{ milestone.scheduledDate | date: 'mediumDate' }}</p>
                                <p class="milestone-description">{{ milestone.description }}</p>
                              </div>
                            </div>
                          }
                        </div>
                      </div>
                    }

                    <!-- Recommendations -->
                    @if (probationCalculation()!.recommendations.length > 0) {
                      <div class="recommendations-section">
                        <strong>Recommendations:</strong>
                        <ul class="recommendations-list">
                          @for (rec of probationCalculation()!.recommendations; track rec) {
                            <li>{{ rec }}</li>
                          }
                        </ul>
                      </div>
                    }
                  </div>
                }

                <!-- ============================================ -->
                <!-- ADVANCED INTELLIGENCE FEATURES (8 NEW)       -->
                <!-- ============================================ -->

                <!-- 1. OVERTIME COMPLIANCE MONITOR -->
                @if (overtimeCompliance()) {
                  <div class="insight-card overtime-compliance" [class]="'risk-' + overtimeCompliance()!.riskLevel">
                    <div class="insight-header">
                      <app-icon name="schedule"></app-icon>
                      <strong>Overtime Compliance</strong>
                      <app-chip
                        [label]="overtimeCompliance()!.isCompliant ? 'Compliant' : 'Non-Compliant'"
                        [variant]="overtimeCompliance()!.isCompliant ? 'success' : 'error'">
                      </app-chip>
                    </div>

                    <div class="compliance-summary">
                      <div class="summary-row">
                        <span>Weekly Hours:</span>
                        <strong>{{ overtimeCompliance()!.weeklyHours }}h / {{ overtimeCompliance()!.maxLegalHours }}h</strong>
                      </div>
                      <div class="summary-row">
                        <span>Overtime:</span>
                        <strong>{{ overtimeCompliance()!.overtimeHours }}h</strong>
                      </div>
                      @if (overtimeCompliance()!.violations.length > 0) {
                        <div class="violations-section">
                          <strong class="error-text">⚠️ {{ overtimeCompliance()!.violations.length }} Violation(s)</strong>
                          @for (violation of overtimeCompliance()!.violations; track violation.type) {
                            <div class="violation-item">• {{ violation.description }}</div>
                          }
                        </div>
                      }
                      @if (overtimeCompliance()!.restPeriodViolations.length > 0) {
                        <div class="violations-section">
                          <strong class="error-text">⚠️ {{ overtimeCompliance()!.restPeriodViolations.length }} Rest Period Violation(s)</strong>
                          @for (violation of overtimeCompliance()!.restPeriodViolations; track violation.date) {
                            <div class="violation-item">• {{ violation.restHours }}h rest (requires {{ violation.requiredRestHours }}h)</div>
                          }
                        </div>
                      }
                    </div>

                    @if (overtimeCompliance()!.recommendations.length > 0) {
                      <div class="recommendations-section">
                        <strong>Recommendations:</strong>
                        <ul class="recommendations-list">
                          @for (rec of overtimeCompliance()!.recommendations; track rec) {
                            <li>{{ rec }}</li>
                          }
                        </ul>
                      </div>
                    }
                  </div>
                }

                <!-- 2. SALARY ANOMALY DETECTOR -->
                @if (salaryAnomalies()) {
                  <div class="insight-card salary-anomalies" [class]="'risk-' + salaryAnomalies()!.overallRiskLevel">
                    <div class="insight-header">
                      <app-icon name="account_balance_wallet"></app-icon>
                      <strong>Salary Analysis</strong>
                      <app-chip
                        [label]="salaryAnomalies()!.hasAnomalies ? 'Anomalies Detected' : 'No Issues'"
                        [variant]="salaryAnomalies()!.hasAnomalies ? 'warning' : 'success'">
                      </app-chip>
                    </div>

                    <div class="salary-summary">
                      <!-- Gender Pay Gap -->
                      <div class="summary-section">
                        <strong>Gender Pay Gap:</strong>
                        <div class="summary-row">
                          <span>Gap Percentage:</span>
                          <strong [class.error-text]="!salaryAnomalies()!.genderPayGapAnalysis.isCompliant">
                            {{ salaryAnomalies()!.genderPayGapAnalysis.gapPercentage }}%
                          </strong>
                        </div>
                        <div class="summary-row">
                          <span>Compliance:</span>
                          <strong [class.success-text]="salaryAnomalies()!.genderPayGapAnalysis.isCompliant"
                                  [class.error-text]="!salaryAnomalies()!.genderPayGapAnalysis.isCompliant">
                            {{ salaryAnomalies()!.genderPayGapAnalysis.isCompliant ? 'Compliant' : 'Non-Compliant' }}
                          </strong>
                        </div>
                      </div>

                      <!-- Market Rate Comparison -->
                      <div class="summary-section">
                        <strong>Market Rate:</strong>
                        <div class="summary-row">
                          <span>Position:</span>
                          <strong>{{ salaryAnomalies()!.marketRateComparison.positionInRange | titlecase }}</strong>
                        </div>
                        <div class="summary-row">
                          <span>Competitiveness:</span>
                          <strong [class.success-text]="salaryAnomalies()!.marketRateComparison.isCompetitive"
                                  [class.warning-text]="!salaryAnomalies()!.marketRateComparison.isCompetitive">
                            {{ salaryAnomalies()!.marketRateComparison.isCompetitive ? 'Competitive' : 'Below Market' }}
                          </strong>
                        </div>
                      </div>

                      <!-- Anomalies -->
                      @if (salaryAnomalies()!.anomalies.length > 0) {
                        <div class="anomalies-section">
                          <strong>Detected Anomalies:</strong>
                          @for (anomaly of salaryAnomalies()!.anomalies; track anomaly.type) {
                            <div class="anomaly-item" [class.high-severity]="anomaly.severity === 'high'">
                              <span class="anomaly-type">{{ anomaly.description }}</span>
                              <span class="anomaly-diff">{{ anomaly.percentageDifference > 0 ? '+' : '' }}{{ anomaly.percentageDifference }}%</span>
                            </div>
                          }
                        </div>
                      }
                    </div>

                    @if (salaryAnomalies()!.recommendations.length > 0) {
                      <div class="recommendations-section">
                        <strong>Recommendations:</strong>
                        <ul class="recommendations-list">
                          @for (rec of salaryAnomalies()!.recommendations; track rec) {
                            <li>{{ rec }}</li>
                          }
                        </ul>
                      </div>
                    }
                  </div>
                }

                <!-- 3. RETENTION RISK SCORER -->
                @if (retentionRisk()) {
                  <div class="insight-card retention-risk" [class]="'risk-' + retentionRisk()!.riskLevel">
                    <div class="insight-header">
                      <app-icon name="groups"></app-icon>
                      <strong>Retention Risk Assessment</strong>
                      <app-chip
                        [label]="retentionRisk()!.riskLevel + ' risk'"
                        [variant]="retentionRisk()!.riskLevel === 'high' ? 'error' : retentionRisk()!.riskLevel === 'medium' ? 'warning' : 'success'">
                      </app-chip>
                    </div>

                    <div class="risk-summary">
                      <div class="risk-score-display">
                        <div class="score-circle" [class]="'risk-' + retentionRisk()!.riskLevel">
                          <span class="score-value">{{ retentionRisk()!.riskScore }}</span>
                          <span class="score-label">Risk Score</span>
                        </div>
                        <div class="flight-risk">
                          <strong>Flight Risk:</strong>
                          <span>{{ retentionRisk()!.flightRiskPercentage }}%</span>
                        </div>
                      </div>

                      <div class="summary-row highlight">
                        <span>Replacement Cost:</span>
                        <strong class="cost-value">MUR {{ retentionRisk()!.replacementCost.toLocaleString() }}</strong>
                      </div>

                      @if (retentionRisk()!.riskFactors.length > 0) {
                        <div class="risk-factors-section">
                          <strong>Risk Factors:</strong>
                          @for (factor of retentionRisk()!.riskFactors; track factor.factor) {
                            <div class="risk-factor-item" [class]="'impact-' + factor.impact">
                              <span class="factor-name">{{ factor.description }}</span>
                              <span class="factor-weight">Weight: {{ factor.weight }}%</span>
                            </div>
                          }
                        </div>
                      }
                    </div>

                    @if (retentionRisk()!.recommendations.length > 0) {
                      <div class="recommendations-section">
                        <strong>Action Items:</strong>
                        <ul class="recommendations-list">
                          @for (rec of retentionRisk()!.recommendations; track rec.action) {
                            <li>
                              <strong>[{{ rec.priority | uppercase }}]</strong> {{ rec.action }}
                              @if (rec.timeframe) {
                                <span class="timeframe">({{ rec.timeframe }})</span>
                              }
                            </li>
                          }
                        </ul>
                      </div>
                    }
                  </div>
                }

                <!-- 4. PERFORMANCE REVIEW SCHEDULER -->
                @if (performanceReviews()) {
                  <div class="insight-card performance-reviews" [class]="'status-' + performanceReviews()!.complianceStatus">
                    <div class="insight-header">
                      <app-icon name="assessment"></app-icon>
                      <strong>Performance Review Schedule</strong>
                      <app-chip
                        [label]="performanceReviews()!.complianceStatus"
                        [variant]="performanceReviews()!.complianceStatus === 'compliant' ? 'success' : performanceReviews()!.complianceStatus === 'warning' ? 'warning' : 'error'">
                      </app-chip>
                    </div>

                    <div class="reviews-summary">
                      <div class="summary-row">
                        <span>Review Cycle:</span>
                        <strong>{{ performanceReviews()!.reviewCycle | titlecase }}</strong>
                      </div>

                      @if (performanceReviews()!.nextReview) {
                        <div class="summary-row highlight">
                          <span>Next Review:</span>
                          <strong>{{ performanceReviews()!.nextReview.dueDate | date }}</strong>
                        </div>
                      }

                      @if (performanceReviews()!.hasOverdueReviews) {
                        <div class="overdue-section">
                          <strong class="error-text">⚠️ {{ performanceReviews()!.overdueReviews.length }} Overdue Review(s)</strong>
                          @for (review of performanceReviews()!.overdueReviews; track review.reviewNumber) {
                            <div class="overdue-item">
                              • Review #{{ review.reviewNumber }}: {{ review.daysOverdue }} days overdue
                            </div>
                          }
                        </div>
                      }

                      <div class="reviews-timeline">
                        <strong>Review History:</strong>
                        @for (review of performanceReviews()!.reviews.slice(0, 5); track review.reviewNumber) {
                          <div class="timeline-item" [class]="'status-' + review.status">
                            <span class="review-number">#{{ review.reviewNumber }}</span>
                            <span class="review-date">{{ review.dueDate | date }}</span>
                            <app-chip
                              [label]="review.status"
                              [variant]="review.status === 'completed' ? 'success' : review.status === 'overdue' ? 'error' : 'default'">
                            </app-chip>
                          </div>
                        }
                      </div>
                    </div>

                    @if (performanceReviews()!.recommendations.length > 0) {
                      <div class="recommendations-section">
                        <strong>Recommendations:</strong>
                        <ul class="recommendations-list">
                          @for (rec of performanceReviews()!.recommendations; track rec) {
                            <li>{{ rec }}</li>
                          }
                        </ul>
                      </div>
                    }
                  </div>
                }

                <!-- 5. TRAINING NEEDS ANALYZER -->
                @if (trainingNeeds()) {
                  <div class="insight-card training-needs" [class]="'compliance-' + trainingNeeds()!.complianceStatus">
                    <div class="insight-header">
                      <app-icon name="school"></app-icon>
                      <strong>Training Needs Analysis</strong>
                      <app-chip
                        [label]="trainingNeeds()!.complianceStatus"
                        [variant]="trainingNeeds()!.complianceStatus === 'compliant' ? 'success' : 'error'">
                      </app-chip>
                    </div>

                    <div class="training-summary">
                      <div class="summary-row">
                        <span>Estimated Budget:</span>
                        <strong>MUR {{ trainingNeeds()!.trainingBudgetEstimate.toLocaleString() }}</strong>
                      </div>
                      <div class="summary-row">
                        <span>Estimated Hours:</span>
                        <strong>{{ trainingNeeds()!.estimatedTrainingHours }}h</strong>
                      </div>

                      <!-- Mandatory Training Status -->
                      <div class="mandatory-training-section">
                        <strong>Mandatory Training:</strong>
                        @for (training of trainingNeeds()!.mandatoryTraining; track training.trainingName) {
                          <div class="training-item" [class.completed]="training.isCompleted" [class.expired]="training.isExpired">
                            <app-icon [name]="training.isCompleted && !training.isExpired ? 'check_circle' : 'cancel'"></app-icon>
                            <span class="training-name">{{ training.trainingName }}</span>
                            @if (training.isExpired) {
                              <span class="status-badge expired">Expired</span>
                            } @else if (!training.isCompleted) {
                              <span class="status-badge pending">Pending</span>
                            } @else {
                              <span class="status-badge completed">Completed</span>
                            }
                          </div>
                        }
                      </div>

                      <!-- Skill Gaps -->
                      @if (trainingNeeds()!.skillGaps.length > 0) {
                        <div class="skill-gaps-section">
                          <strong>Skill Gaps Identified:</strong>
                          @for (gap of trainingNeeds()!.skillGaps; track gap.skillName) {
                            <div class="skill-gap-item" [class]="'priority-' + gap.priority">
                              <span class="skill-name">{{ gap.skillName }}</span>
                              <span class="skill-level">{{ gap.currentLevel }} → {{ gap.requiredLevel }}</span>
                              <span class="training-rec">{{ gap.recommendedTraining }}</span>
                            </div>
                          }
                        </div>
                      }
                    </div>

                    @if (trainingNeeds()!.recommendations.length > 0) {
                      <div class="recommendations-section">
                        <strong>Recommendations:</strong>
                        <ul class="recommendations-list">
                          @for (rec of trainingNeeds()!.recommendations; track rec) {
                            <li>{{ rec }}</li>
                          }
                        </ul>
                      </div>
                    }
                  </div>
                }

                <!-- 6. CAREER PROGRESSION ANALYZER -->
                @if (careerProgression()) {
                  <div class="insight-card career-progression" [class.promotion-ready]="careerProgression()!.isPromotionReady">
                    <div class="insight-header">
                      <app-icon name="trending_up"></app-icon>
                      <strong>Career Progression</strong>
                      <app-chip
                        [label]="careerProgression()!.isPromotionReady ? 'Promotion Ready' : 'In Development'"
                        [variant]="careerProgression()!.isPromotionReady ? 'success' : 'default'">
                      </app-chip>
                    </div>

                    <div class="progression-summary">
                      <div class="level-progression">
                        <span class="current-level">{{ careerProgression()!.currentLevel | titlecase }}</span>
                        <app-icon name="arrow_forward"></app-icon>
                        <span class="next-level">{{ careerProgression()!.nextLevel | titlecase }}</span>
                      </div>

                      <div class="readiness-score">
                        <div class="score-bar">
                          <div class="score-fill" [style.width.%]="careerProgression()!.promotionReadinessScore"></div>
                        </div>
                        <span class="score-label">{{ careerProgression()!.promotionReadinessScore }}% Ready</span>
                      </div>

                      @if (careerProgression()!.estimatedMonthsToPromotion > 0) {
                        <div class="summary-row">
                          <span>Estimated Time to Promotion:</span>
                          <strong>{{ careerProgression()!.estimatedMonthsToPromotion }} months</strong>
                        </div>
                      }

                      <!-- Qualification Checklist -->
                      <div class="qualifications-section">
                        <strong>Promotion Qualifications:</strong>
                        @for (qual of careerProgression()!.qualifications; track qual.criterion) {
                          <div class="qualification-item" [class.met]="qual.isMet">
                            <app-icon [name]="qual.isMet ? 'check_circle' : 'radio_button_unchecked'"></app-icon>
                            <span class="qual-criterion">{{ qual.criterion }}</span>
                            <span class="qual-status">{{ qual.currentValue }} / {{ qual.requiredValue }}</span>
                          </div>
                        }
                      </div>
                    </div>

                    @if (careerProgression()!.developmentRecommendations.length > 0) {
                      <div class="recommendations-section">
                        <strong>Development Plan:</strong>
                        <ul class="recommendations-list">
                          @for (rec of careerProgression()!.developmentRecommendations; track rec) {
                            <li>{{ rec }}</li>
                          }
                        </ul>
                      </div>
                    }
                  </div>
                }

                <!-- 7. VISA/WORK PERMIT RENEWAL FORECASTER -->
                @if (visaRenewal()) {
                  <div class="insight-card visa-renewal" [class]="'urgency-' + visaRenewal()!.urgencyLevel">
                    <div class="insight-header">
                      <app-icon name="flight_takeoff"></app-icon>
                      <strong>Visa Renewal Forecast</strong>
                      <app-chip
                        [label]="visaRenewal()!.urgencyLevel + ' urgency'"
                        [variant]="visaRenewal()!.urgencyLevel === 'critical' || visaRenewal()!.urgencyLevel === 'high' ? 'error' : visaRenewal()!.urgencyLevel === 'medium' ? 'warning' : 'success'">
                      </app-chip>
                    </div>

                    <div class="visa-summary">
                      <div class="summary-row">
                        <span>Permit Type:</span>
                        <strong>{{ visaRenewal()!.permitType.replace('_', ' ') | titlecase }}</strong>
                      </div>
                      <div class="summary-row highlight">
                        <span>Days Until Expiry:</span>
                        <strong [class.error-text]="visaRenewal()!.daysUntilExpiry < 30">
                          {{ visaRenewal()!.daysUntilExpiry }} days
                        </strong>
                      </div>
                      <div class="summary-row">
                        <span>Processing Time:</span>
                        <strong>{{ visaRenewal()!.estimatedProcessingDays }} days</strong>
                      </div>
                      <div class="summary-row">
                        <span>Recommended Start:</span>
                        <strong>{{ visaRenewal()!.recommendedStartDate | date }}</strong>
                      </div>

                      <!-- Renewal Timeline -->
                      <div class="timeline-section">
                        <strong>Renewal Milestones:</strong>
                        @for (milestone of visaRenewal()!.renewalTimeline; track milestone.milestone) {
                          <div class="timeline-item"
                               [class.completed]="milestone.isCompleted"
                               [class.urgent]="milestone.priority === 'urgent' && !milestone.isCompleted">
                            <div class="milestone-status">
                              <app-icon [name]="milestone.isCompleted ? 'check_circle' : 'schedule'"></app-icon>
                            </div>
                            <div class="milestone-content">
                              <span class="milestone-name">{{ milestone.milestone }}</span>
                              <span class="milestone-date">{{ milestone.dueDate | date }}</span>
                              @if (!milestone.isCompleted && milestone.daysUntil !== null) {
                                <span class="days-until">{{ milestone.daysUntil > 0 ? milestone.daysUntil + ' days' : 'Overdue' }}</span>
                              }
                            </div>
                          </div>
                        }
                      </div>

                      <!-- Required Documents -->
                      <div class="documents-section">
                        <strong>Required Documents ({{ visaRenewal()!.requiredDocuments.length }}):</strong>
                        @for (doc of visaRenewal()!.requiredDocuments; track doc.documentName) {
                          <div class="document-item" [class.submitted]="doc.isSubmitted">
                            <app-icon [name]="doc.isSubmitted ? 'check_box' : 'check_box_outline_blank'"></app-icon>
                            <span>{{ doc.documentName }}</span>
                          </div>
                        }
                      </div>
                    </div>

                    @if (visaRenewal()!.recommendations.length > 0) {
                      <div class="recommendations-section">
                        <strong>Action Items:</strong>
                        <ul class="recommendations-list">
                          @for (rec of visaRenewal()!.recommendations; track rec) {
                            <li>{{ rec }}</li>
                          }
                        </ul>
                      </div>
                    }
                  </div>
                }

                <!-- No Insights Message -->
                @if (!passportDetectionResult() && !workPermitRecommendation() && !expiryAlerts().length && !taxCalculation() && !sectorCompliance() && !leaveBalancePrediction() && !probationCalculation() && !overtimeCompliance() && !salaryAnomalies() && !retentionRisk() && !performanceReviews() && !trainingNeeds() && !careerProgression() && !visaRenewal()) {
                  <div class="no-insights">
                    <app-icon name="lightbulb"></app-icon>
                    <p>Fill in employee details to see intelligent recommendations and compliance checks</p>
                  </div>
                }
              </div>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 2: EMPLOYMENT DETAILS ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon
                [name]="getSectionIcon(employmentFields)"
                [class]="getSectionIconClass(employmentFields)">
              </app-icon>
              Employment Details - Position and department information
            </div>

            <div class="form-grid">
              <app-input
                label="Employee Code *"
                placeholder="EMP001"
                formControlName="employeeCode"
                hint="Unique identifier"
                [required]="true"
                [error]="getFieldError('employeeCode')">
              </app-input>

              <app-select
                label="Employee Type *"
                placeholder="Select employee type"
                formControlName="employeeType"
                [options]="employeeTypeOptions"
                [required]="true"
                [error]="getFieldError('employeeType')">
              </app-select>

              <app-select
                label="Department *"
                placeholder="Select department"
                formControlName="department"
                [options]="departmentOptions"
                [required]="true"
                [error]="getFieldError('department')">
              </app-select>

              <app-input
                label="Designation *"
                placeholder="Production Manager"
                formControlName="designation"
                [required]="true"
                [error]="getFieldError('designation')">
              </app-input>

              <app-select
                label="Industry Sector *"
                placeholder="Select industry sector"
                formControlName="industrySector"
                [options]="industrySectorOptions"
                [required]="true"
                [error]="getFieldError('industrySector')">
              </app-select>

              <app-input
                label="Work Location"
                placeholder="Head Office"
                formControlName="workLocation">
              </app-input>

              <app-input
                label="Reporting To"
                placeholder="Manager name"
                formControlName="reportingTo">
              </app-input>

              <app-datepicker
                label="Join Date *"
                formControlName="joinDate"
                [required]="true"
                [error]="getFieldError('joinDate')">
              </app-datepicker>

              <app-input
                label="Probation Period (Months)"
                type="number"
                placeholder="3"
                formControlName="probationPeriodMonths">
              </app-input>

              <app-select
                label="Employment Contract Type *"
                placeholder="Select contract type"
                formControlName="employmentContractType"
                [options]="employmentContractTypeOptions"
                [required]="true"
                [error]="getFieldError('employmentContractType')">
              </app-select>

              <app-select
                label="Employment Status *"
                placeholder="Select employment status"
                formControlName="employmentStatus"
                [options]="employmentStatusOptions"
                [required]="true"
                [error]="getFieldError('employmentStatus')">
              </app-select>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 3: COMPENSATION & BANKING ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="payments"></app-icon>
              Compensation & Banking - Salary and allowances
            </div>

            <div class="form-grid">
              <app-input
                label="Base Salary (MUR) *"
                type="number"
                placeholder="30000"
                formControlName="baseSalary"
                [required]="true"
                [error]="getFieldError('baseSalary')">
              </app-input>

              <app-select
                label="Payment Frequency *"
                placeholder="Select frequency"
                formControlName="paymentFrequency"
                [options]="paymentFrequencyOptions"
                [required]="true"
                [error]="getFieldError('paymentFrequency')">
              </app-select>

              <app-input
                label="Transport Allowance (MUR)"
                type="number"
                placeholder="0"
                formControlName="transportAllowance">
              </app-input>

              <app-input
                label="Housing Allowance (MUR)"
                type="number"
                placeholder="0"
                formControlName="housingAllowance">
              </app-input>

              <app-input
                label="Meal Allowance (MUR)"
                type="number"
                placeholder="0"
                formControlName="mealAllowance">
              </app-input>

              <app-input
                class="full-width"
                label="Bank Name"
                placeholder="MCB, SBM, etc."
                formControlName="bankName">
              </app-input>

              <app-input
                label="Bank Account Number"
                formControlName="bankAccountNumber">
              </app-input>

              <app-input
                label="Bank Branch Code"
                formControlName="bankBranchCode">
              </app-input>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 4: STATUTORY COMPLIANCE ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="verified_user"></app-icon>
              Statutory Compliance (Mauritius) - CSG, NSF, Tax, PRGF
            </div>

            <div class="form-grid">
              <app-input
                label="CSG Number"
                placeholder="Contribution Sociale Générale"
                formControlName="csgNumber"
                hint="Contribution Sociale Générale">
              </app-input>

              <app-input
                label="NSF Number"
                placeholder="National Savings Fund"
                formControlName="nsfNumber"
                hint="National Savings Fund">
              </app-input>

              <app-input
                label="Tax ID Number (TAN)"
                formControlName="taxIdNumber">
              </app-input>

              <app-input
                label="PRGF Number"
                placeholder="Portable Retirement Gratuity Fund"
                formControlName="prNumber"
                hint="Portable Retirement Gratuity Fund">
              </app-input>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 5: LEAVE ENTITLEMENTS ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="event_available"></app-icon>
              Leave Entitlements - Annual, sick, casual leave
            </div>

            <div class="form-grid">
              <app-input
                label="Annual Leave Days *"
                type="number"
                placeholder="20"
                formControlName="annualLeaveDays"
                [required]="true"
                [error]="getFieldError('annualLeaveDays')">
              </app-input>

              <app-input
                label="Sick Leave Days *"
                type="number"
                placeholder="15"
                formControlName="sickLeaveDays"
                [required]="true"
                [error]="getFieldError('sickLeaveDays')">
              </app-input>

              <app-input
                label="Casual Leave Days *"
                type="number"
                placeholder="5"
                formControlName="casualLeaveDays"
                [required]="true"
                [error]="getFieldError('casualLeaveDays')">
              </app-input>

              <app-checkbox
                class="full-width"
                label="Allow carry forward of unused leave"
                formControlName="carryForwardAllowed">
              </app-checkbox>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 6: EMERGENCY CONTACT ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="contact_phone"></app-icon>
              Emergency Contact - Person to contact in emergency
            </div>

            <div class="form-grid">
              <app-input
                label="Contact Name *"
                formControlName="emergencyContactName"
                [required]="true"
                [error]="getFieldError('emergencyContactName')">
              </app-input>

              <app-select
                label="Relation *"
                placeholder="Select relation"
                formControlName="emergencyContactRelation"
                [options]="emergencyContactRelationOptions"
                [required]="true"
                [error]="getFieldError('emergencyContactRelation')">
              </app-select>

              <app-input
                label="Contact Phone *"
                type="tel"
                formControlName="emergencyContactPhone"
                [required]="true"
                [error]="getFieldError('emergencyContactPhone')">
              </app-input>

              <app-input
                class="full-width"
                label="Contact Address"
                formControlName="emergencyContactAddress">
              </app-input>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 7: QUALIFICATIONS & DOCUMENTS ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="school"></app-icon>
              Qualifications & Documents - Education and file uploads
            </div>

            <div class="form-grid">
              <app-select
                label="Highest Qualification"
                placeholder="Select qualification"
                formControlName="highestQualification"
                [options]="highestQualificationOptions">
              </app-select>

              <app-input
                label="University/Institution"
                formControlName="university">
              </app-input>

              <app-input
                class="full-width"
                label="Skills"
                placeholder="e.g., Leadership, Communication, Technical skills"
                formControlName="skills">
              </app-input>

              <app-input
                class="full-width"
                label="Languages"
                placeholder="e.g., English, French, Creole"
                formControlName="languages">
              </app-input>

              <div class="document-uploads full-width">
                <h4 class="subsection-title">Document Uploads</h4>
                <p class="info-text">
                  <app-icon name="info"></app-icon>
                  Document upload feature will be implemented with file storage integration
                </p>
              </div>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 8: SALARY COMPONENTS ========== -->
          @if (isEditMode() && employeeId) {
            <app-expansion-panel>
              <div panel-title>
                <app-icon name="account_balance_wallet"></app-icon>
                Salary Components - Manage allowances and deductions
              </div>


              <div class="salary-components-section">
                <!-- Loading State -->
                @if (loadingSalaryComponents()) {
                  <div class="loading-state">
                    <app-progress-spinner size="medium" color="primary"></app-progress-spinner>
                    <p>Loading salary components...</p>
                  </div>
                }
                <!-- Empty State -->
                @if (!loadingSalaryComponents() && employeeSalaryComponents().length === 0) {
                  <div class="empty-state">
                    <app-icon name="inbox"></app-icon>
                    <p>No salary components assigned yet</p>
                    <button mat-raised-button color="primary" (click)="openSalaryComponentsManagement()">
                      <app-icon name="add"></app-icon>
                      Add Components
                    </button>
                  </div>
                }
                <!-- Components List -->
                @if (!loadingSalaryComponents() && employeeSalaryComponents().length > 0) {
                  <div class="components-list">
                    <div class="components-header">
                      <h3>Active Components</h3>
                      <button mat-raised-button color="primary" (click)="openSalaryComponentsManagement()">
                        <app-icon name="settings"></app-icon>
                        Manage All
                      </button>
                    </div>
                    <div class="component-cards">
                      @for (component of employeeSalaryComponents(); track component) {
                        <mat-card class="component-card">
                          <mat-card-content>
                            <div class="component-header">
                              <div class="component-info">
                                <h4>{{ component.componentName }}</h4>
                                <app-chip
                                  [label]="component.componentType"
                                  [color]="component.componentType === 'Allowance' ? 'success' : 'error'"
                                  [variant]="'filled'">
                                </app-chip>
                              </div>
                              <div class="component-amount">
                                {{ formatCurrency(component.amount) }}
                              </div>
                            </div>
                            <div class="component-details">
                              <div class="detail-row">
                                <app-icon name="event"></app-icon>
                                <span>Effective: {{ formatDate(component.effectiveDate) }}</span>
                              </div>
                              @if (component.endDate) {
                                <div class="detail-row">
                                  <app-icon name="event_busy"></app-icon>
                                  <span>End: {{ formatDate(component.endDate) }}</span>
                                </div>
                              }
                              <div class="detail-row">
                                <app-icon [name]="component.isRecurring ? 'loop' : 'event_note' "></app-icon>
                                <span>{{ component.isRecurring ? 'Recurring' : 'One-time' }}</span>
                              </div>
                              @if (component.requiresApproval) {
                                <div class="detail-row">
                                  <app-icon [name]="component.isApproved ? 'check_circle' : 'schedule'" [class]="component.isApproved ? 'approved' : 'pending'"></app-icon>
                                  <span>{{ component.isApproved ? 'Approved' : 'Pending Approval' }}</span>
                                </div>
                              }
                            </div>
                            @if (component.description) {
                              <div class="component-description">
                                <p>{{ component.description }}</p>
                              </div>
                            }
                          </mat-card-content>
                        </mat-card>
                      }
                    </div>
                    <!-- Summary -->
                    <div class="components-summary">
                      <div class="summary-item allowances">
                        <app-icon name="add_circle"></app-icon>
                        <div>
                          <span class="label">Total Allowances</span>
                          <span class="value">{{ formatCurrency(getTotalAllowances()) }}</span>
                        </div>
                      </div>
                      <div class="summary-item deductions">
                        <app-icon name="remove_circle"></app-icon>
                        <div>
                          <span class="label">Total Deductions</span>
                          <span class="value">{{ formatCurrency(getTotalDeductions()) }}</span>
                        </div>
                      </div>
                      <div class="summary-item net">
                        <app-icon name="account_balance"></app-icon>
                        <div>
                          <span class="label">Net Adjustment</span>
                          <span class="value">{{ formatCurrency(getNetAdjustment()) }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </app-expansion-panel>
          }

          <!-- ========== SECTION 9: ADDITIONAL INFORMATION ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="notes"></app-icon>
              Additional Information - Optional notes and remarks
            </div>

            <div class="form-grid">
              <app-input
                class="full-width"
                label="Notes"
                placeholder="Any additional information or remarks about the employee"
                formControlName="notes">
              </app-input>
            </div>
          </app-expansion-panel>

        </app-expansion-panel-group>

        <!-- Form Actions -->
        <div class="form-actions">
          <app-button
            type="button"
            variant="ghost"
            [disabled]="loading()"
            (click)="cancel()">
            <app-icon name="close"></app-icon>
            Cancel
          </app-button>

          <app-button
            type="button"
            variant="secondary"
            [disabled]="saving() || loading()"
            (click)="saveDraft()">
            <app-icon name="save"></app-icon>
            Save Draft
          </app-button>

          <app-button
            type="submit"
            variant="primary"
            [disabled]="loading() || !employeeForm.valid"
            [loading]="loading()">
            <app-icon name="check_circle"></app-icon>
            {{ isEditMode() ? 'Update Employee' : 'Create Employee' }}
          </app-button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
