<div class="employee-form-container">
  <mat-card class="form-card">
    <!-- Header -->
    <mat-card-header>
      <div class="header-content">
        <button mat-icon-button routerLink="/tenant/employees" class="back-button">
          <app-icon name="arrow_back"></app-icon>
        </button>
        <div class="header-text">
          <h1>{{ isEditMode() ? 'Edit Employee' : 'Add New Employee' }}</h1>
          <p class="subtitle">Complete all required fields to register employee</p>
        </div>
      </div>
    </mat-card-header>

    <!-- Progress Bar -->
    <div class="progress-section">
      <div class="progress-header">
        <span class="progress-label">Completion Progress</span>
        <span class="progress-percentage">{{ completionPercentage() }}%</span>
      </div>
      <mat-progress-bar
        mode="determinate"
        [value]="completionPercentage()"
        [color]="completionPercentage() === 100 ? 'primary' : 'accent'">
      </mat-progress-bar>
      <div class="save-status">
        <app-icon [name]="saving() ? 'cloud_upload' : 'cloud_done'" [class.saving]="saving()"></app-icon>
        <span>{{ getSaveStatusText() }}</span>
      </div>
    </div>

    <!-- Error Message -->
    @if (error()) {
      <div class="error-banner">
        <app-icon name="error"></app-icon>
        <span>{{ error() }}</span>
      </div>
    }

    <mat-card-content>
      <form [formGroup]="employeeForm" (ngSubmit)="onSubmit()">
        <app-expansion-panel-group [multi]="true">

          <!-- ========== SECTION 1: PERSONAL INFORMATION ========== -->
          <app-expansion-panel [expanded]="personalInfoExpanded">
            <div panel-title>
              <app-icon name="person"></app-icon>
              Personal Information - Basic employee details
            </div>

            <div class="form-grid">
              <app-input
                label="First Name *"
                placeholder="John"
                formControlName="firstName"
                [required]="true"
                [error]="getFieldError('firstName')">
              </app-input>

              <app-input
                label="Last Name *"
                placeholder="Doe"
                formControlName="lastName"
                [required]="true"
                [error]="getFieldError('lastName')">
              </app-input>

              <app-datepicker
                label="Date of Birth *"
                formControlName="dateOfBirth"
                [required]="true"
                [error]="getFieldError('dateOfBirth')">
              </app-datepicker>

              <app-select
                label="Gender *"
                placeholder="Select gender"
                formControlName="gender"
                [options]="genderOptions"
                [required]="true"
                [error]="getFieldError('gender')">
              </app-select>

              <app-select
                label="Nationality *"
                placeholder="Select nationality"
                formControlName="nationality"
                [options]="nationalityOptions"
                [required]="true"
                [error]="getFieldError('nationality')">
              </app-select>

              <app-input
                label="National Identity Card (NIC) *"
                placeholder="A1234567890123"
                formControlName="nic"
                hint="Mauritius NIC format"
                [required]="true"
                [error]="getFieldError('nic')">
              </app-input>

              <app-input
                label="Phone Number *"
                type="tel"
                placeholder="+230 5123 4567"
                formControlName="phoneNumber"
                [required]="true"
                [error]="getFieldError('phoneNumber')">
              </app-input>

              <app-input
                label="Email Address *"
                type="email"
                placeholder="john.doe@company.mu"
                formControlName="email"
                [required]="true"
                [error]="getFieldError('email')">
              </app-input>

              <app-input
                label="Alternate Email"
                type="email"
                formControlName="alternateEmail"
                [error]="getFieldError('alternateEmail')">
              </app-input>

              <app-select
                label="Blood Group"
                placeholder="Select blood group"
                formControlName="bloodGroup"
                [options]="bloodGroupOptions">
              </app-select>

              <!-- Mauritius Address Section -->
              <div class="address-section full-width">
                <h4 class="subsection-title">Residential Address (Mauritius)</h4>
                <div class="form-grid">
                  <app-select
                    label="District *"
                    placeholder="Select district first"
                    formControlName="district"
                    [options]="districtOptions"
                    hint="Select district first"
                    [required]="true"
                    [error]="getFieldError('district')"
                    (valueChange)="onDistrictChange($event)">
                  </app-select>

                  <app-select
                    label="Village/Locality"
                    placeholder="Select district first"
                    formControlName="village"
                    [options]="villageOptions"
                    hint="Optional - auto-filled by postal code">
                  </app-select>

                  <app-input
                    label="Postal Code"
                    placeholder="11302"
                    formControlName="postalCode"
                    hint="Enter postal code to auto-fill address"
                    (blur)="onPostalCodeBlur(employeeForm.get('postalCode')?.value)">
                  </app-input>

                  <app-input
                    label="City/Town"
                    placeholder="Port Louis"
                    formControlName="city"
                    hint="Auto-filled from postal code">
                  </app-input>

                  <app-input
                    class="full-width"
                    label="Address Line 1 *"
                    placeholder="House/Building number, Street name"
                    formControlName="addressLine1"
                    [required]="true"
                    [error]="getFieldError('addressLine1')">
                  </app-input>

                  <app-input
                    class="full-width"
                    label="Address Line 2"
                    placeholder="Additional address details (optional)"
                    formControlName="addressLine2">
                  </app-input>

                  <app-input
                    label="Region"
                    placeholder="e.g., North, South"
                    formControlName="region"
                    hint="Auto-filled from postal code">
                  </app-input>

                  <app-select
                    label="Country *"
                    placeholder="Select country"
                    formControlName="country"
                    [options]="countryOptions"
                    [required]="true"
                    [error]="getFieldError('country')">
                  </app-select>
                </div>
              </div>

              <!-- Expatriate-specific fields -->
              @if (isExpatriate()) {
                <div class="expatriate-section full-width">
                  <h4 class="subsection-title">Expatriate Documents</h4>
                  <div class="form-grid">
                    <app-input
                      label="Passport Number *"
                      formControlName="passportNumber"
                      [required]="true"
                      [error]="getFieldError('passportNumber')">
                    </app-input>

                    <app-datepicker
                      label="Passport Expiry Date *"
                      formControlName="passportExpiryDate"
                      [required]="true"
                      [error]="getFieldError('passportExpiryDate')">
                    </app-datepicker>

                    <app-input
                      label="Visa Number *"
                      formControlName="visaNumber"
                      [required]="true"
                      [error]="getFieldError('visaNumber')">
                    </app-input>

                    <app-datepicker
                      label="Visa Expiry Date"
                      formControlName="visaExpiryDate">
                    </app-datepicker>

                    <app-input
                      label="Work Permit Number *"
                      formControlName="workPermitNumber"
                      [required]="true"
                      [error]="getFieldError('workPermitNumber')">
                    </app-input>

                    <app-datepicker
                      label="Work Permit Expiry Date"
                      formControlName="workPermitExpiryDate">
                    </app-datepicker>

                    <app-select
                      label="Work Permit Type"
                      placeholder="Select permit type"
                      formControlName="workPermitType"
                      [options]="workPermitTypeOptions">
                    </app-select>

                    <app-input
                      label="Residence Permit Number"
                      formControlName="residencePermitNumber">
                    </app-input>
                  </div>
                </div>
              }
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 2: EMPLOYMENT DETAILS ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="work"></app-icon>
              Employment Details - Position and department information
            </div>

            <div class="form-grid">
              <app-input
                label="Employee Code *"
                placeholder="EMP001"
                formControlName="employeeCode"
                hint="Unique identifier"
                [required]="true"
                [error]="getFieldError('employeeCode')">
              </app-input>

              <app-select
                label="Employee Type *"
                placeholder="Select employee type"
                formControlName="employeeType"
                [options]="employeeTypeOptions"
                [required]="true"
                [error]="getFieldError('employeeType')">
              </app-select>

              <app-select
                label="Department *"
                placeholder="Select department"
                formControlName="department"
                [options]="departmentOptions"
                [required]="true"
                [error]="getFieldError('department')">
              </app-select>

              <app-input
                label="Designation *"
                placeholder="Production Manager"
                formControlName="designation"
                [required]="true"
                [error]="getFieldError('designation')">
              </app-input>

              <app-select
                label="Industry Sector *"
                placeholder="Select industry sector"
                formControlName="industrySector"
                [options]="industrySectorOptions"
                [required]="true"
                [error]="getFieldError('industrySector')">
              </app-select>

              <app-input
                label="Work Location"
                placeholder="Head Office"
                formControlName="workLocation">
              </app-input>

              <app-input
                label="Reporting To"
                placeholder="Manager name"
                formControlName="reportingTo">
              </app-input>

              <app-datepicker
                label="Join Date *"
                formControlName="joinDate"
                [required]="true"
                [error]="getFieldError('joinDate')">
              </app-datepicker>

              <app-input
                label="Probation Period (Months)"
                type="number"
                placeholder="3"
                formControlName="probationPeriodMonths">
              </app-input>

              <app-select
                label="Employment Contract Type *"
                placeholder="Select contract type"
                formControlName="employmentContractType"
                [options]="employmentContractTypeOptions"
                [required]="true"
                [error]="getFieldError('employmentContractType')">
              </app-select>

              <app-select
                label="Employment Status *"
                placeholder="Select employment status"
                formControlName="employmentStatus"
                [options]="employmentStatusOptions"
                [required]="true"
                [error]="getFieldError('employmentStatus')">
              </app-select>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 3: COMPENSATION & BANKING ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="payments"></app-icon>
              Compensation & Banking - Salary and allowances
            </div>

            <div class="form-grid">
              <app-input
                label="Base Salary (MUR) *"
                type="number"
                placeholder="30000"
                formControlName="baseSalary"
                [required]="true"
                [error]="getFieldError('baseSalary')">
              </app-input>

              <app-select
                label="Payment Frequency *"
                placeholder="Select frequency"
                formControlName="paymentFrequency"
                [options]="paymentFrequencyOptions"
                [required]="true"
                [error]="getFieldError('paymentFrequency')">
              </app-select>

              <app-input
                label="Transport Allowance (MUR)"
                type="number"
                placeholder="0"
                formControlName="transportAllowance">
              </app-input>

              <app-input
                label="Housing Allowance (MUR)"
                type="number"
                placeholder="0"
                formControlName="housingAllowance">
              </app-input>

              <app-input
                label="Meal Allowance (MUR)"
                type="number"
                placeholder="0"
                formControlName="mealAllowance">
              </app-input>

              <app-input
                class="full-width"
                label="Bank Name"
                placeholder="MCB, SBM, etc."
                formControlName="bankName">
              </app-input>

              <app-input
                label="Bank Account Number"
                formControlName="bankAccountNumber">
              </app-input>

              <app-input
                label="Bank Branch Code"
                formControlName="bankBranchCode">
              </app-input>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 4: STATUTORY COMPLIANCE ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="verified_user"></app-icon>
              Statutory Compliance (Mauritius) - CSG, NSF, Tax, PRGF
            </div>

            <div class="form-grid">
              <app-input
                label="CSG Number"
                placeholder="Contribution Sociale Générale"
                formControlName="csgNumber"
                hint="Contribution Sociale Générale">
              </app-input>

              <app-input
                label="NSF Number"
                placeholder="National Savings Fund"
                formControlName="nsfNumber"
                hint="National Savings Fund">
              </app-input>

              <app-input
                label="Tax ID Number (TAN)"
                formControlName="taxIdNumber">
              </app-input>

              <app-input
                label="PRGF Number"
                placeholder="Portable Retirement Gratuity Fund"
                formControlName="prNumber"
                hint="Portable Retirement Gratuity Fund">
              </app-input>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 5: LEAVE ENTITLEMENTS ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="event_available"></app-icon>
              Leave Entitlements - Annual, sick, casual leave
            </div>

            <div class="form-grid">
              <app-input
                label="Annual Leave Days *"
                type="number"
                placeholder="20"
                formControlName="annualLeaveDays"
                [required]="true"
                [error]="getFieldError('annualLeaveDays')">
              </app-input>

              <app-input
                label="Sick Leave Days *"
                type="number"
                placeholder="15"
                formControlName="sickLeaveDays"
                [required]="true"
                [error]="getFieldError('sickLeaveDays')">
              </app-input>

              <app-input
                label="Casual Leave Days *"
                type="number"
                placeholder="5"
                formControlName="casualLeaveDays"
                [required]="true"
                [error]="getFieldError('casualLeaveDays')">
              </app-input>

              <app-checkbox
                class="full-width"
                label="Allow carry forward of unused leave"
                formControlName="carryForwardAllowed">
              </app-checkbox>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 6: EMERGENCY CONTACT ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="contact_phone"></app-icon>
              Emergency Contact - Person to contact in emergency
            </div>

            <div class="form-grid">
              <app-input
                label="Contact Name *"
                formControlName="emergencyContactName"
                [required]="true"
                [error]="getFieldError('emergencyContactName')">
              </app-input>

              <app-select
                label="Relation *"
                placeholder="Select relation"
                formControlName="emergencyContactRelation"
                [options]="emergencyContactRelationOptions"
                [required]="true"
                [error]="getFieldError('emergencyContactRelation')">
              </app-select>

              <app-input
                label="Contact Phone *"
                type="tel"
                formControlName="emergencyContactPhone"
                [required]="true"
                [error]="getFieldError('emergencyContactPhone')">
              </app-input>

              <app-input
                class="full-width"
                label="Contact Address"
                formControlName="emergencyContactAddress">
              </app-input>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 7: QUALIFICATIONS & DOCUMENTS ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="school"></app-icon>
              Qualifications & Documents - Education and file uploads
            </div>

            <div class="form-grid">
              <app-select
                label="Highest Qualification"
                placeholder="Select qualification"
                formControlName="highestQualification"
                [options]="highestQualificationOptions">
              </app-select>

              <app-input
                label="University/Institution"
                formControlName="university">
              </app-input>

              <app-input
                class="full-width"
                label="Skills"
                placeholder="e.g., Leadership, Communication, Technical skills"
                formControlName="skills">
              </app-input>

              <app-input
                class="full-width"
                label="Languages"
                placeholder="e.g., English, French, Creole"
                formControlName="languages">
              </app-input>

              <div class="document-uploads full-width">
                <h4 class="subsection-title">Document Uploads</h4>
                <p class="info-text">
                  <app-icon name="info"></app-icon>
                  Document upload feature will be implemented with file storage integration
                </p>
              </div>
            </div>
          </app-expansion-panel>

          <!-- ========== SECTION 8: SALARY COMPONENTS ========== -->
          @if (isEditMode() && employeeId) {
            <app-expansion-panel>
              <div panel-title>
                <app-icon name="account_balance_wallet"></app-icon>
                Salary Components - Manage allowances and deductions
              </div>


              <div class="salary-components-section">
                <!-- Loading State -->
                @if (loadingSalaryComponents()) {
                  <div class="loading-state">
                    <app-progress-spinner size="medium" color="primary"></app-progress-spinner>
                    <p>Loading salary components...</p>
                  </div>
                }
                <!-- Empty State -->
                @if (!loadingSalaryComponents() && employeeSalaryComponents().length === 0) {
                  <div class="empty-state">
                    <app-icon name="inbox"></app-icon>
                    <p>No salary components assigned yet</p>
                    <button mat-raised-button color="primary" (click)="openSalaryComponentsManagement()">
                      <app-icon name="add"></app-icon>
                      Add Components
                    </button>
                  </div>
                }
                <!-- Components List -->
                @if (!loadingSalaryComponents() && employeeSalaryComponents().length > 0) {
                  <div class="components-list">
                    <div class="components-header">
                      <h3>Active Components</h3>
                      <button mat-raised-button color="primary" (click)="openSalaryComponentsManagement()">
                        <app-icon name="settings"></app-icon>
                        Manage All
                      </button>
                    </div>
                    <div class="component-cards">
                      @for (component of employeeSalaryComponents(); track component) {
                        <mat-card class="component-card">
                          <mat-card-content>
                            <div class="component-header">
                              <div class="component-info">
                                <h4>{{ component.componentName }}</h4>
                                <app-chip
                                  [label]="component.componentType"
                                  [color]="component.componentType === 'Allowance' ? 'success' : 'error'"
                                  [variant]="'filled'">
                                </app-chip>
                              </div>
                              <div class="component-amount">
                                {{ formatCurrency(component.amount) }}
                              </div>
                            </div>
                            <div class="component-details">
                              <div class="detail-row">
                                <app-icon name="event"></app-icon>
                                <span>Effective: {{ formatDate(component.effectiveDate) }}</span>
                              </div>
                              @if (component.endDate) {
                                <div class="detail-row">
                                  <app-icon name="event_busy"></app-icon>
                                  <span>End: {{ formatDate(component.endDate) }}</span>
                                </div>
                              }
                              <div class="detail-row">
                                <app-icon [name]="component.isRecurring ? 'loop' : 'event_note' "></app-icon>
                                <span>{{ component.isRecurring ? 'Recurring' : 'One-time' }}</span>
                              </div>
                              @if (component.requiresApproval) {
                                <div class="detail-row">
                                  <app-icon [name]="component.isApproved ? 'check_circle' : 'schedule'" [class]="component.isApproved ? 'approved' : 'pending'"></app-icon>
                                  <span>{{ component.isApproved ? 'Approved' : 'Pending Approval' }}</span>
                                </div>
                              }
                            </div>
                            @if (component.description) {
                              <div class="component-description">
                                <p>{{ component.description }}</p>
                              </div>
                            }
                          </mat-card-content>
                        </mat-card>
                      }
                    </div>
                    <!-- Summary -->
                    <div class="components-summary">
                      <div class="summary-item allowances">
                        <app-icon name="add_circle"></app-icon>
                        <div>
                          <span class="label">Total Allowances</span>
                          <span class="value">{{ formatCurrency(getTotalAllowances()) }}</span>
                        </div>
                      </div>
                      <div class="summary-item deductions">
                        <app-icon name="remove_circle"></app-icon>
                        <div>
                          <span class="label">Total Deductions</span>
                          <span class="value">{{ formatCurrency(getTotalDeductions()) }}</span>
                        </div>
                      </div>
                      <div class="summary-item net">
                        <app-icon name="account_balance"></app-icon>
                        <div>
                          <span class="label">Net Adjustment</span>
                          <span class="value">{{ formatCurrency(getNetAdjustment()) }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </app-expansion-panel>
          }

          <!-- ========== SECTION 9: ADDITIONAL INFORMATION ========== -->
          <app-expansion-panel>
            <div panel-title>
              <app-icon name="notes"></app-icon>
              Additional Information - Optional notes and remarks
            </div>

            <div class="form-grid">
              <app-input
                class="full-width"
                label="Notes"
                placeholder="Any additional information or remarks about the employee"
                formControlName="notes">
              </app-input>
            </div>
          </app-expansion-panel>

        </app-expansion-panel-group>

        <!-- Form Actions -->
        <div class="form-actions">
          <app-button
            type="button"
            variant="ghost"
            [disabled]="loading()"
            (click)="cancel()">
            <app-icon name="close"></app-icon>
            Cancel
          </app-button>

          <app-button
            type="button"
            variant="secondary"
            [disabled]="saving() || loading()"
            (click)="saveDraft()">
            <app-icon name="save"></app-icon>
            Save Draft
          </app-button>

          <app-button
            type="submit"
            variant="primary"
            [disabled]="loading() || !employeeForm.valid"
            [loading]="loading()">
            <app-icon name="check_circle"></app-icon>
            {{ isEditMode() ? 'Update Employee' : 'Create Employee' }}
          </app-button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
