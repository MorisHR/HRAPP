<div class="billing-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Billing & Subscription</h1>
      <p class="subtitle">Manage your subscription and payment history</p>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="refresh()">
        <app-icon name="refresh"></app-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <app-progress-spinner size="medium" color="primary"></app-progress-spinner>
      <p>Loading subscription details...</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon color="warn">error_outline</mat-icon>
          <div class="error-text">
            <h3>Unable to Load Billing Information</h3>
            <p>{{ error() }}</p>
            @if (error()?.includes('not yet implemented')) {
              <div class="implementation-note">
                <h4>For Developers:</h4>
                <p>Create the following backend endpoint:</p>
                <code>GET /api/tenant/subscription</code>
                <p>Authorization: Admin, HR roles</p>
                <p>Returns: Subscription details and payment history for current tenant</p>
              </div>
            }
          </div>
        </div>
        <div class="error-actions">
          <button mat-raised-button color="primary" (click)="refresh()">
            <app-icon name="refresh"></app-icon>
            Try Again
          </button>
          <button mat-button (click)="contactSupport()">
            <app-icon name="support_agent"></app-icon>
            Contact Support
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Main Content -->
  @if (subscription() && !loading()) {
    <!-- Subscription Overview Cards -->
    <div class="overview-grid">
      <!-- Current Subscription Card -->
      <mat-card class="subscription-card">
        <mat-card-header>
          <mat-card-title>
            <app-icon name="workspace_premium"></app-icon>
            Current Subscription
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="subscription-details">
            <div class="detail-row">
              <span class="label">Company:</span>
              <span class="value">{{ subscription()!.companyName }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Subscription Tier:</span>
              <app-chip
                [label]="subscription()!.tier"
                [color]="'primary'">
              </app-chip>
            </div>
            <div class="detail-row">
              <span class="label">Employee Limit:</span>
              <span class="value">{{ subscription()!.currentEmployeeCount }} / {{ subscription()!.employeeLimit }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Yearly Price:</span>
              <span class="value price">{{ formatCurrency(subscription()!.yearlyPriceMUR) }}</span>
            </div>
            <app-divider />
            <div class="detail-row">
              <span class="label">Status:</span>
              <app-chip
                [label]="subscription()!.status"
                [color]="getSubscriptionStatusColor(subscription()!.status)">
              </app-chip>
            </div>
            <div class="detail-row">
              <span class="label">Start Date:</span>
              <span class="value">{{ formatDate(subscription()!.subscriptionStartDate) }}</span>
            </div>
            <div class="detail-row">
              <span class="label">End Date:</span>
              <span class="value">{{ formatDate(subscription()!.subscriptionEndDate) }}</span>
            </div>
            <div class="detail-row" [class]="expiryWarningClass()">
              <span class="label">Days Until Renewal:</span>
              <span class="value days-count">{{ subscription()!.daysUntilExpiry }} days</span>
            </div>
          </div>
        </mat-card-content>
        <mat-card-actions>
          <button mat-button color="primary" (click)="upgradeTier()">
            <app-icon name="arrow_upward"></app-icon>
            Upgrade Tier
          </button>
          <button mat-button (click)="contactSupport()">
            <app-icon name="support_agent"></app-icon>
            Contact Support
          </button>
        </mat-card-actions>
      </mat-card>

      <!-- Payment Status Card -->
      <mat-card class="payment-status-card" [class.has-outstanding]="outstandingAmount() > 0">
        <mat-card-header>
          <mat-card-title>
            <app-icon name="payment"></app-icon>
            Payment Status
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (outstandingAmount() > 0) {
            <div class="outstanding-amount">
              <div class="amount-label">Outstanding Amount</div>
              <div class="amount-value">{{ formatCurrency(outstandingAmount()) }}</div>
            </div>

            @if (nextPaymentDue()) {
              <app-divider />
              <div class="next-payment">
                <div class="payment-info">
                  <span class="label">Next Payment Due:</span>
                  <span class="value">{{ formatDate(nextPaymentDue()!.dueDate) }}</span>
                </div>
                <div class="payment-info">
                  <span class="label">Amount:</span>
                  <span class="value">{{ formatCurrency(nextPaymentDue()!.amountMUR) }}</span>
                </div>
                <div class="payment-info">
                  <span class="label">Status:</span>
                  <app-chip
                    [label]="nextPaymentDue()!.status"
                    [color]="getStatusColor(nextPaymentDue()!.status)">
                  </app-chip>
                </div>
              </div>

              @if (nextPaymentDue()!.status === 'Overdue') {
                <div class="overdue-warning">
                  <app-icon name="warning"></app-icon>
                  <span>This payment is overdue. Please contact support to arrange payment.</span>
                </div>
              }
            }
          } @else {
            <div class="all-paid">
              <mat-icon color="primary">check_circle</mat-icon>
              <div class="paid-message">
                <h3>All Payments Up to Date</h3>
                <p>You have no outstanding payments at this time.</p>
              </div>
            </div>
          }
        </mat-card-content>
        @if (outstandingAmount() > 0) {
          <mat-card-actions>
            <button mat-raised-button color="accent" (click)="contactSupport()">
              <app-icon name="payment"></app-icon>
              Arrange Payment
            </button>
          </mat-card-actions>
        }
      </mat-card>
    </div>

    <!-- Payment History -->
    <mat-card class="payment-history-card">
      <mat-card-header>
        <mat-card-title>
          <app-icon name="history"></app-icon>
          Payment History
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (payments().length === 0) {
          <div class="empty-state">
            <app-icon name="receipt_long"></app-icon>
            <h3>No Payment History</h3>
            <p>Your payment history will appear here once payments are recorded.</p>
          </div>
        } @else {
          <div class="table-container">
            <app-table
              [columns]="columns"
              [data]="payments()"
              [loading]="loading()"
              [hoverable]="true"
              class="payment-table">

              <!-- Period Column -->
              <ng-template appTableColumn="period" let-payment>
                {{ getPeriodLabel(payment) }}
              </ng-template>

              <!-- Due Date Column -->
              <ng-template appTableColumn="dueDate" let-payment>
                {{ formatDate(payment.dueDate) }}
              </ng-template>

              <!-- Amount Column -->
              <ng-template appTableColumn="amount" let-payment>
                <span class="amount">{{ formatCurrency(payment.amountMUR) }}</span>
              </ng-template>

              <!-- Status Column -->
              <ng-template appTableColumn="status" let-payment>
                <app-chip
                  [label]="payment.status"
                  [color]="getStatusColor(payment.status)">
                </app-chip>
              </ng-template>

              <!-- Paid Date Column -->
              <ng-template appTableColumn="paidDate" let-payment>
                {{ formatDate(payment.paidDate) }}
              </ng-template>

              <!-- Actions Column -->
              <ng-template appTableColumn="actions" let-payment>
                <button
                  mat-icon-button
                  (click)="viewPaymentDetails(payment)"
                  appTooltip="View Payment Details">
                  <app-icon name="visibility"></app-icon>
                </button>
                <button
                  mat-icon-button
                  [disabled]="!payment.invoiceNumber"
                  (click)="downloadInvoice(payment)"
                  appTooltip="Download Invoice">
                  <app-icon name="download"></app-icon>
                </button>
              </ng-template>
            </app-table>
          </div>
        }
      </mat-card-content>
    </mat-card>
  }
</div>
