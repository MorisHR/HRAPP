<div class="billing-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Billing & Subscription</h1>
      <p class="subtitle">Manage your subscription and payment history</p>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="refresh()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading subscription details...</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon color="warn">error_outline</mat-icon>
          <div class="error-text">
            <h3>Unable to Load Billing Information</h3>
            <p>{{ error() }}</p>
            @if (error()?.includes('not yet implemented')) {
              <div class="implementation-note">
                <h4>For Developers:</h4>
                <p>Create the following backend endpoint:</p>
                <code>GET /api/tenant/subscription</code>
                <p>Authorization: Admin, HR roles</p>
                <p>Returns: Subscription details and payment history for current tenant</p>
              </div>
            }
          </div>
        </div>
        <div class="error-actions">
          <button mat-raised-button color="primary" (click)="refresh()">
            <mat-icon>refresh</mat-icon>
            Try Again
          </button>
          <button mat-button (click)="contactSupport()">
            <mat-icon>support_agent</mat-icon>
            Contact Support
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Main Content -->
  @if (subscription() && !loading()) {
    <!-- Subscription Overview Cards -->
    <div class="overview-grid">
      <!-- Current Subscription Card -->
      <mat-card class="subscription-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>workspace_premium</mat-icon>
            Current Subscription
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="subscription-details">
            <div class="detail-row">
              <span class="label">Company:</span>
              <span class="value">{{ subscription()!.companyName }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Subscription Tier:</span>
              <mat-chip [class]="'tier-' + subscription()!.tier.toLowerCase()">
                {{ subscription()!.tier }}
              </mat-chip>
            </div>
            <div class="detail-row">
              <span class="label">Employee Limit:</span>
              <span class="value">{{ subscription()!.currentEmployeeCount }} / {{ subscription()!.employeeLimit }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Yearly Price:</span>
              <span class="value price">{{ formatCurrency(subscription()!.yearlyPriceMUR) }}</span>
            </div>
            <mat-divider></mat-divider>
            <div class="detail-row">
              <span class="label">Status:</span>
              <mat-chip [class]="statusBadgeClass()">
                {{ subscription()!.status }}
              </mat-chip>
            </div>
            <div class="detail-row">
              <span class="label">Start Date:</span>
              <span class="value">{{ formatDate(subscription()!.subscriptionStartDate) }}</span>
            </div>
            <div class="detail-row">
              <span class="label">End Date:</span>
              <span class="value">{{ formatDate(subscription()!.subscriptionEndDate) }}</span>
            </div>
            <div class="detail-row" [class]="expiryWarningClass()">
              <span class="label">Days Until Renewal:</span>
              <span class="value days-count">{{ subscription()!.daysUntilExpiry }} days</span>
            </div>
          </div>
        </mat-card-content>
        <mat-card-actions>
          <button mat-button color="primary" (click)="upgradeTier()">
            <mat-icon>arrow_upward</mat-icon>
            Upgrade Tier
          </button>
          <button mat-button (click)="contactSupport()">
            <mat-icon>support_agent</mat-icon>
            Contact Support
          </button>
        </mat-card-actions>
      </mat-card>

      <!-- Payment Status Card -->
      <mat-card class="payment-status-card" [class.has-outstanding]="outstandingAmount() > 0">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>payment</mat-icon>
            Payment Status
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (outstandingAmount() > 0) {
            <div class="outstanding-amount">
              <div class="amount-label">Outstanding Amount</div>
              <div class="amount-value">{{ formatCurrency(outstandingAmount()) }}</div>
            </div>

            @if (nextPaymentDue()) {
              <mat-divider></mat-divider>
              <div class="next-payment">
                <div class="payment-info">
                  <span class="label">Next Payment Due:</span>
                  <span class="value">{{ formatDate(nextPaymentDue()!.dueDate) }}</span>
                </div>
                <div class="payment-info">
                  <span class="label">Amount:</span>
                  <span class="value">{{ formatCurrency(nextPaymentDue()!.amountMUR) }}</span>
                </div>
                <div class="payment-info">
                  <span class="label">Status:</span>
                  <mat-chip [color]="getStatusColor(nextPaymentDue()!.status)">
                    {{ nextPaymentDue()!.status }}
                  </mat-chip>
                </div>
              </div>

              @if (nextPaymentDue()!.status === 'Overdue') {
                <div class="overdue-warning">
                  <mat-icon>warning</mat-icon>
                  <span>This payment is overdue. Please contact support to arrange payment.</span>
                </div>
              }
            }
          } @else {
            <div class="all-paid">
              <mat-icon color="primary">check_circle</mat-icon>
              <div class="paid-message">
                <h3>All Payments Up to Date</h3>
                <p>You have no outstanding payments at this time.</p>
              </div>
            </div>
          }
        </mat-card-content>
        @if (outstandingAmount() > 0) {
          <mat-card-actions>
            <button mat-raised-button color="accent" (click)="contactSupport()">
              <mat-icon>payment</mat-icon>
              Arrange Payment
            </button>
          </mat-card-actions>
        }
      </mat-card>
    </div>

    <!-- Payment History -->
    <mat-card class="payment-history-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>history</mat-icon>
          Payment History
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (payments().length === 0) {
          <div class="empty-state">
            <mat-icon>receipt_long</mat-icon>
            <h3>No Payment History</h3>
            <p>Your payment history will appear here once payments are recorded.</p>
          </div>
        } @else {
          <div class="table-container">
            <table mat-table [dataSource]="payments()" class="payment-table">
              <!-- Period Column -->
              <ng-container matColumnDef="period">
                <th mat-header-cell *matHeaderCellDef>Period</th>
                <td mat-cell *matCellDef="let payment">
                  {{ getPeriodLabel(payment) }}
                </td>
              </ng-container>

              <!-- Due Date Column -->
              <ng-container matColumnDef="dueDate">
                <th mat-header-cell *matHeaderCellDef>Due Date</th>
                <td mat-cell *matCellDef="let payment">
                  {{ formatDate(payment.dueDate) }}
                </td>
              </ng-container>

              <!-- Amount Column -->
              <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef>Amount</th>
                <td mat-cell *matCellDef="let payment">
                  <span class="amount">{{ formatCurrency(payment.amountMUR) }}</span>
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let payment">
                  <mat-chip [color]="getStatusColor(payment.status)">
                    {{ payment.status }}
                  </mat-chip>
                </td>
              </ng-container>

              <!-- Paid Date Column -->
              <ng-container matColumnDef="paidDate">
                <th mat-header-cell *matHeaderCellDef>Paid Date</th>
                <td mat-cell *matCellDef="let payment">
                  {{ formatDate(payment.paidDate) }}
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let payment">
                  <button
                    mat-icon-button
                    (click)="viewPaymentDetails(payment)"
                    matTooltip="View Payment Details">
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    [disabled]="!payment.invoiceNumber"
                    (click)="downloadInvoice(payment)"
                    matTooltip="Download Invoice">
                    <mat-icon>download</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>
        }
      </mat-card-content>
    </mat-card>
  }
</div>
