name: Phase 1 Migration CI/CD

on:
  push:
    branches: [main, develop, 'feature/phase1-*']
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18.x'

jobs:
  # ============================================================================
  # BUILD & LINT
  # ============================================================================
  build:
    name: Build & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: hrms-frontend/package-lock.json

      - name: Install dependencies
        working-directory: hrms-frontend
        run: npm ci

      - name: Lint TypeScript
        working-directory: hrms-frontend
        run: npm run lint

      - name: Type check
        working-directory: hrms-frontend
        run: npx tsc --noEmit

      - name: Build application
        working-directory: hrms-frontend
        run: npm run build -- --configuration=production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: hrms-frontend/dist/
          retention-days: 7

  # ============================================================================
  # UNIT TESTS
  # ============================================================================
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: hrms-frontend/package-lock.json

      - name: Install dependencies
        working-directory: hrms-frontend
        run: npm ci

      - name: Run unit tests with coverage
        working-directory: hrms-frontend
        run: npm run test -- --coverage --watchAll=false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: hrms-frontend/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: Coverage threshold check
        working-directory: hrms-frontend
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 85" | bc -l) )); then
            echo "Error: Coverage $COVERAGE% is below 85% threshold"
            exit 1
          fi

  # ============================================================================
  # BUNDLE SIZE ANALYSIS
  # ============================================================================
  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: hrms-frontend/package-lock.json

      - name: Install dependencies
        working-directory: hrms-frontend
        run: npm ci

      - name: Build with stats
        working-directory: hrms-frontend
        run: npm run build -- --configuration=production --stats-json

      - name: Analyze bundle size
        working-directory: hrms-frontend
        run: |
          npm install -g webpack-bundle-analyzer
          npx webpack-bundle-analyzer dist/hrms-frontend/stats.json --mode static --report bundle-report.html --no-open

      - name: Check bundle size limits
        working-directory: hrms-frontend
        run: |
          MAIN_BUNDLE=$(find dist/hrms-frontend/browser -name 'main.*.js' -exec stat -f%z {} \;)
          MAX_SIZE=500000  # 500KB
          echo "Main bundle size: $((MAIN_BUNDLE / 1024))KB"
          if [ $MAIN_BUNDLE -gt $MAX_SIZE ]; then
            echo "Error: Main bundle exceeds 500KB limit"
            exit 1
          fi

      - name: Upload bundle report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-report
          path: hrms-frontend/bundle-report.html

  # ============================================================================
  # ACCESSIBILITY TESTS
  # ============================================================================
  test-a11y:
    name: Accessibility Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: hrms-frontend/package-lock.json

      - name: Install dependencies
        working-directory: hrms-frontend
        run: npm ci

      - name: Run accessibility tests
        working-directory: hrms-frontend
        run: npm run test:a11y || echo "A11y tests not configured yet"

  # ============================================================================
  # PERFORMANCE TESTS (LIGHTHOUSE)
  # ============================================================================
  test-performance:
    name: Performance Tests (Lighthouse)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: hrms-frontend/package-lock.json

      - name: Install dependencies
        working-directory: hrms-frontend
        run: npm ci

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse CI
        working-directory: hrms-frontend
        run: lhci autorun || echo "Lighthouse results available in artifacts"
        continue-on-error: true

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: hrms-frontend/.lighthouseci/

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: hrms-frontend/package-lock.json

      - name: Install dependencies
        working-directory: hrms-frontend
        run: npm ci

      - name: Run npm audit
        working-directory: hrms-frontend
        run: npm audit --audit-level=moderate

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'HRMS-Frontend'
          path: 'hrms-frontend'
          format: 'HTML'

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: reports/

  # ============================================================================
  # DEPLOY TO STAGING
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, test-unit, bundle-analysis, test-a11y, security-scan]
    if: github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/phase1')
    environment:
      name: staging
      url: https://staging.hrms.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: hrms-frontend/dist/

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Add actual deployment commands here
          # e.g., rsync, cloud storage upload, etc.

      - name: Configure feature flags (0%)
        run: |
          echo "Setting feature flags to 0% for safe deployment"
          # Add feature flag configuration API calls

  # ============================================================================
  # DEPLOY TO PRODUCTION
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, test-unit, bundle-analysis, test-a11y, test-performance, security-scan]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://hrms.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: hrms-frontend/dist/

      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          # Add actual production deployment commands

      - name: Configure feature flags (0% initially)
        run: |
          echo "Setting Phase 1 feature flags to 0% for gradual rollout"
          # Add feature flag configuration

      - name: Create deployment tag
        run: |
          git tag -a "phase1-v1.0.0-$(date +%Y%m%d-%H%M%S)" -m "Phase 1 production deployment"
          git push origin --tags

  # ============================================================================
  # MONITORING & ROLLBACK
  # ============================================================================
  post-deployment-monitoring:
    name: Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 300  # 5 minutes

      - name: Check error rates
        run: |
          echo "Checking error rates from monitoring..."
          # Add monitoring API calls

      - name: Check performance metrics
        run: |
          echo "Checking performance metrics..."
          # Add performance monitoring checks

      - name: Gradual rollout (10%)
        run: |
          echo "Increasing feature flag to 10%"
          # Add feature flag update to 10%
