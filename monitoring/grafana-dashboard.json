{
  "dashboard": {
    "title": "HRMS Database Health & Performance",
    "description": "Comprehensive database monitoring for HRMS including migrations, encryption, and performance metrics",
    "tags": ["database", "postgresql", "hrms", "monitoring"],
    "timezone": "browser",
    "schemaVersion": 38,
    "version": 1,
    "refresh": "30s",
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "timepicker": {
      "refresh_intervals": ["5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d"]
    },
    "templating": {
      "list": [
        {
          "name": "database",
          "type": "query",
          "label": "Database",
          "query": "SELECT datname FROM pg_database WHERE datname NOT IN ('template0', 'template1', 'postgres')",
          "current": {
            "text": "hrms_db",
            "value": "hrms_db"
          },
          "multi": false,
          "includeAll": false
        },
        {
          "name": "schema",
          "type": "query",
          "label": "Schema",
          "query": "SELECT schema_name FROM information_schema.schemata WHERE schema_name NOT IN ('pg_catalog', 'information_schema')",
          "current": {
            "text": "tenant_default",
            "value": "tenant_default"
          },
          "multi": false,
          "includeAll": false
        }
      ]
    },
    "panels": [
      {
        "id": 1,
        "title": "Database Status",
        "type": "stat",
        "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
        "targets": [
          {
            "expr": "pg_up",
            "legendFormat": "Database Status"
          }
        ],
        "options": {
          "colorMode": "background",
          "graphMode": "none",
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "mappings": [
              {"type": "value", "value": "1", "text": "UP", "color": "green"},
              {"type": "value", "value": "0", "text": "DOWN", "color": "red"}
            ],
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "red"},
                {"value": 1, "color": "green"}
              ]
            }
          }
        }
      },
      {
        "id": 2,
        "title": "Active Connections",
        "type": "gauge",
        "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
        "targets": [
          {
            "expr": "pg_stat_activity_count{state='active'}",
            "legendFormat": "Active Connections"
          }
        ],
        "options": {
          "showThresholdLabels": true,
          "showThresholdMarkers": true
        },
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "min": 0,
            "max": 500,
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 350, "color": "yellow"},
                {"value": 400, "color": "orange"},
                {"value": 450, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 3,
        "title": "Cache Hit Ratio",
        "type": "gauge",
        "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
        "targets": [
          {
            "expr": "rate(pg_stat_database_blks_hit{datname='$database'}[5m]) / (rate(pg_stat_database_blks_hit{datname='$database'}[5m]) + rate(pg_stat_database_blks_read{datname='$database'}[5m])) * 100",
            "legendFormat": "Cache Hit Ratio"
          }
        ],
        "options": {
          "showThresholdLabels": true,
          "showThresholdMarkers": true
        },
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "min": 0,
            "max": 100,
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "red"},
                {"value": 85, "color": "orange"},
                {"value": 90, "color": "yellow"},
                {"value": 95, "color": "green"}
              ]
            }
          }
        }
      },
      {
        "id": 4,
        "title": "Database Size",
        "type": "stat",
        "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
        "targets": [
          {
            "expr": "pg_database_size_bytes{datname='$database'}",
            "legendFormat": "Database Size"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "bytes",
            "decimals": 2,
            "color": {"mode": "thresholds"},
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 10737418240, "color": "yellow"},
                {"value": 107374182400, "color": "orange"}
              ]
            }
          }
        }
      },
      {
        "id": 5,
        "title": "Connections Over Time",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
        "targets": [
          {
            "expr": "pg_stat_activity_count",
            "legendFormat": "Total Connections"
          },
          {
            "expr": "pg_stat_activity_count{state='active'}",
            "legendFormat": "Active"
          },
          {
            "expr": "pg_stat_activity_count{state='idle'}",
            "legendFormat": "Idle"
          },
          {
            "expr": "pg_stat_activity_count{state='idle in transaction'}",
            "legendFormat": "Idle in Transaction"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "color": {"mode": "palette-classic"}
          }
        }
      },
      {
        "id": 6,
        "title": "Query Performance",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(query_duration_seconds_bucket[5m]))",
            "legendFormat": "95th Percentile"
          },
          {
            "expr": "histogram_quantile(0.99, rate(query_duration_seconds_bucket[5m]))",
            "legendFormat": "99th Percentile"
          },
          {
            "expr": "avg(rate(query_duration_seconds_sum[5m]) / rate(query_duration_seconds_count[5m]))",
            "legendFormat": "Average"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "s",
            "color": {"mode": "palette-classic"}
          },
          "overrides": [
            {
              "matcher": {"id": "byName", "options": "99th Percentile"},
              "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]
            }
          ]
        }
      },
      {
        "id": 7,
        "title": "Encryption Operations Rate",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
        "targets": [
          {
            "expr": "rate(encryption_operations_total{operation_type='encrypt',success='true'}[5m])",
            "legendFormat": "Encryptions/sec (Success)"
          },
          {
            "expr": "rate(encryption_operations_total{operation_type='decrypt',success='true'}[5m])",
            "legendFormat": "Decryptions/sec (Success)"
          },
          {
            "expr": "rate(encryption_operations_total{success='false'}[5m])",
            "legendFormat": "Failures/sec"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "ops",
            "color": {"mode": "palette-classic"}
          },
          "overrides": [
            {
              "matcher": {"id": "byName", "options": "Failures/sec"},
              "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]
            }
          ]
        }
      },
      {
        "id": 8,
        "title": "Encryption Performance",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(encryption_duration_seconds_bucket{operation_type='encrypt'}[5m]))",
            "legendFormat": "Encryption - 95th %ile"
          },
          {
            "expr": "histogram_quantile(0.95, rate(encryption_duration_seconds_bucket{operation_type='decrypt'}[5m]))",
            "legendFormat": "Decryption - 95th %ile"
          },
          {
            "expr": "avg(rate(encryption_duration_seconds_sum[5m]) / rate(encryption_duration_seconds_count[5m]))",
            "legendFormat": "Average Duration"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "s",
            "color": {"mode": "palette-classic"}
          }
        }
      },
      {
        "id": 9,
        "title": "Lock Monitoring",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 20},
        "targets": [
          {
            "expr": "pg_locks_count{mode='AccessExclusiveLock'}",
            "legendFormat": "Exclusive Locks"
          },
          {
            "expr": "pg_locks_count{mode='RowExclusiveLock'}",
            "legendFormat": "Row Exclusive Locks"
          },
          {
            "expr": "pg_locks_count{granted='false'}",
            "legendFormat": "Waiting for Lock"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "color": {"mode": "palette-classic"}
          },
          "overrides": [
            {
              "matcher": {"id": "byName", "options": "Waiting for Lock"},
              "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]
            }
          ]
        }
      },
      {
        "id": 10,
        "title": "Index Performance - Top 10 by Scans",
        "type": "table",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 20},
        "targets": [
          {
            "expr": "topk(10, index_scan_count{schema='$schema'})",
            "format": "table",
            "instant": true
          }
        ],
        "fieldConfig": {
          "defaults": {},
          "overrides": []
        },
        "options": {
          "showHeader": true,
          "sortBy": [{"displayName": "Scans", "desc": true}]
        },
        "transformations": [
          {
            "id": "organize",
            "options": {
              "excludeByName": {},
              "indexByName": {
                "index_name": 0,
                "table_name": 1,
                "Value": 2
              },
              "renameByName": {
                "index_name": "Index",
                "table_name": "Table",
                "Value": "Scans"
              }
            }
          }
        ]
      },
      {
        "id": 11,
        "title": "Slow Queries (>5s)",
        "type": "table",
        "gridPos": {"h": 8, "w": 24, "x": 0, "y": 28},
        "targets": [
          {
            "expr": "pg_stat_activity_max_tx_duration{state='active'} > 5",
            "format": "table",
            "instant": true
          }
        ],
        "fieldConfig": {
          "defaults": {},
          "overrides": []
        },
        "transformations": [
          {
            "id": "organize",
            "options": {
              "renameByName": {
                "pid": "PID",
                "usename": "User",
                "query": "Query",
                "Value": "Duration (s)"
              }
            }
          }
        ]
      },
      {
        "id": 12,
        "title": "Migration Status",
        "type": "stat",
        "gridPos": {"h": 4, "w": 6, "x": 0, "y": 36},
        "targets": [
          {
            "expr": "migration_status",
            "legendFormat": "Migration Status"
          }
        ],
        "options": {
          "colorMode": "background",
          "graphMode": "none",
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "mappings": [
              {"type": "value", "value": "0", "text": "None", "color": "green"},
              {"type": "value", "value": "1", "text": "Running", "color": "yellow"},
              {"type": "value", "value": "2", "text": "Failed", "color": "red"},
              {"type": "value", "value": "3", "text": "Success", "color": "green"}
            ]
          }
        }
      },
      {
        "id": 13,
        "title": "Migration Duration",
        "type": "stat",
        "gridPos": {"h": 4, "w": 6, "x": 6, "y": 36},
        "targets": [
          {
            "expr": "migration_duration_seconds",
            "legendFormat": "Duration"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "s",
            "color": {"mode": "thresholds"},
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 300, "color": "yellow"},
                {"value": 600, "color": "orange"},
                {"value": 1800, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 14,
        "title": "Constraint Violations",
        "type": "timeseries",
        "gridPos": {"h": 4, "w": 12, "x": 12, "y": 36},
        "targets": [
          {
            "expr": "rate(constraint_violations_total[5m])",
            "legendFormat": "{{constraint_name}}"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "color": {"mode": "palette-classic"}
          }
        }
      },
      {
        "id": 15,
        "title": "Table Sizes - Top 10",
        "type": "bargauge",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 40},
        "targets": [
          {
            "expr": "topk(10, pg_table_size_bytes{schema='$schema'})",
            "legendFormat": "{{table_name}}"
          }
        ],
        "options": {
          "orientation": "horizontal",
          "displayMode": "gradient"
        },
        "fieldConfig": {
          "defaults": {
            "unit": "bytes"
          }
        }
      },
      {
        "id": 16,
        "title": "Deadlocks & Conflicts",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 40},
        "targets": [
          {
            "expr": "rate(pg_stat_database_deadlocks{datname='$database'}[5m])",
            "legendFormat": "Deadlocks/sec"
          },
          {
            "expr": "rate(pg_stat_database_conflicts{datname='$database'}[5m])",
            "legendFormat": "Conflicts/sec"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "color": {"mode": "palette-classic"}
          },
          "overrides": [
            {
              "matcher": {"id": "byName", "options": "Deadlocks/sec"},
              "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]
            }
          ]
        }
      },
      {
        "id": 17,
        "title": "Replication Lag",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 48},
        "targets": [
          {
            "expr": "pg_replication_lag_seconds",
            "legendFormat": "Replication Lag"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "s",
            "color": {"mode": "thresholds"},
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 60, "color": "yellow"},
                {"value": 300, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 18,
        "title": "Transaction Rate",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 48},
        "targets": [
          {
            "expr": "rate(pg_stat_database_xact_commit{datname='$database'}[5m])",
            "legendFormat": "Commits/sec"
          },
          {
            "expr": "rate(pg_stat_database_xact_rollback{datname='$database'}[5m])",
            "legendFormat": "Rollbacks/sec"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "color": {"mode": "palette-classic"}
          },
          "overrides": [
            {
              "matcher": {"id": "byName", "options": "Rollbacks/sec"},
              "properties": [{"id": "color", "value": {"fixedColor": "orange", "mode": "fixed"}}]
            }
          ]
        }
      },
      {
        "id": 19,
        "title": "Disk I/O",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 56},
        "targets": [
          {
            "expr": "rate(pg_stat_database_blks_read{datname='$database'}[5m])",
            "legendFormat": "Disk Blocks Read/sec"
          },
          {
            "expr": "rate(pg_stat_database_blks_hit{datname='$database'}[5m])",
            "legendFormat": "Cache Blocks Hit/sec"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "color": {"mode": "palette-classic"}
          }
        }
      },
      {
        "id": 20,
        "title": "Encryption Health",
        "type": "stat",
        "gridPos": {"h": 4, "w": 6, "x": 12, "y": 56},
        "targets": [
          {
            "expr": "encryption_health_check",
            "legendFormat": "Encryption Service"
          }
        ],
        "options": {
          "colorMode": "background",
          "graphMode": "none",
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "mappings": [
              {"type": "value", "value": "1", "text": "Healthy", "color": "green"},
              {"type": "value", "value": "0", "text": "Unhealthy", "color": "red"}
            ]
          }
        }
      },
      {
        "id": 21,
        "title": "Passthrough Mode Status",
        "type": "stat",
        "gridPos": {"h": 4, "w": 6, "x": 18, "y": 56},
        "targets": [
          {
            "expr": "encryption_passthrough_mode",
            "legendFormat": "Passthrough Mode"
          }
        ],
        "options": {
          "colorMode": "background",
          "graphMode": "none",
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "mappings": [
              {"type": "value", "value": "0", "text": "Disabled", "color": "green"},
              {"type": "value", "value": "1", "text": "ACTIVE - CRITICAL!", "color": "red"}
            ]
          }
        }
      }
    ],
    "annotations": {
      "list": [
        {
          "name": "Migrations",
          "datasource": "PostgreSQL",
          "enable": true,
          "iconColor": "blue",
          "query": "SELECT NOW() as time, 'Migration: ' || \"MigrationId\" as text FROM tenant_default.\"__EFMigrationsHistory\" WHERE \"MigrationId\" >= NOW() - INTERVAL '7 days'"
        },
        {
          "name": "Alerts",
          "datasource": "Prometheus",
          "enable": true,
          "iconColor": "red",
          "expr": "ALERTS{alertstate='firing'}"
        }
      ]
    }
  }
}
